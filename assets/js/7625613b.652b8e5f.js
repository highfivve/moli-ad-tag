"use strict";(self.webpackChunkthe_publisher_ad_tag=self.webpackChunkthe_publisher_ad_tag||[]).push([[6911],{8453:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>a});var i=s(6540);const t={},r=i.createContext(t);function d(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),i.createElement(r.Provider,{value:n},e.children)}},9549:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"features/single-page-app","title":"Single Page Applications","description":"Single Page Applications (SPA) are web applications that load a single HTML page and dynamically update that page as the","source":"@site/docs/features/single-page-app.md","sourceDirName":"features","slug":"/features/single-page-app","permalink":"/moli-ad-tag/docs/features/single-page-app","draft":false,"unlisted":false,"editUrl":"https://github.com/highfivve/moli-ad-tag/docs/features/single-page-app.md","tags":[],"version":"current","frontMatter":{"title":"Single Page Applications"},"sidebar":"docs","previous":{"title":"Ad Slot Buckets","permalink":"/moli-ad-tag/docs/features/buckets"},"next":{"title":"Debugging","permalink":"/moli-ad-tag/docs/features/debugging"}}');var t=s(4848),r=s(8453);const d={title:"Single Page Applications"},a=void 0,l={},o=[{value:"Main Challenge",id:"main-challenge",level:2},{value:"Solution",id:"solution",level:2},{value:"State Management",id:"state-management",level:2},{value:"requestAds",id:"requestads",level:3},{value:"refreshAdSlot / refreshInfiniteAdSlot / refreshBucket",id:"refreshadslot--refreshinfiniteadslot--refreshbucket",level:3},{value:"addLabel / setTargeting",id:"addlabel--settargeting",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"Single Page Applications (SPA) are web applications that load a single HTML page and dynamically update that page as the\nuser interacts with the app. This approach allows for a more fluid user experience, but it also introduces some\nchallenges for ad serving as you have to manage state and lifecycle of the ads yourself."}),"\n",(0,t.jsx)(n.p,{children:"The line between classic server-side rendered (SSR) websites and SPAs is blurring. Many websites are a mix of both as\nframeworks like Next.js and Nuxt.js allow you to render pages on the server and then hydrate them on the client. There\nare multiple different approaches to get the best of both worlds, with different trade-offs and complexities."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"SSR - Server-side rendering"}),"\n",(0,t.jsx)(n.li,{children:"SSG - Static site generation"}),"\n",(0,t.jsx)(n.li,{children:"SSR + CSR - Server-side rendering with client-side hydration"}),"\n",(0,t.jsx)(n.li,{children:"CSR - Client-side rendering"}),"\n",(0,t.jsx)(n.li,{children:"ISR - Incremental static regeneration"}),"\n",(0,t.jsx)(n.li,{children:"SPA - Single page application"}),"\n",(0,t.jsx)(n.li,{children:"Island Architecture"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Here are some links that explain those concepts in more detail:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://www.youtube.com/watch?v=uBxehYwQox4",children:"Server Islands are really cool (Video)"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://nextjs.org/docs/pages/building-your-application/rendering/server-side-rendering",children:"next.js server-side rendering"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://dev.to/crunchstack/choose-the-rendering-method-spa-vs-ssr-vs-ssg-121f",children:"choose your rendering method spa vs ssr vs ssg"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.astro.build/en/concepts/islands/",children:"astro islands"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"main-challenge",children:"Main Challenge"}),"\n",(0,t.jsx)(n.p,{children:"The main challenge with user navigation without a real page reload is the state management. This includes"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Remove existing ad slots after page navigation"}),"\n",(0,t.jsx)(n.li,{children:"Add new ad slots after page navigation"}),"\n",(0,t.jsx)(n.li,{children:"Refresh ad slots after the necessary component is mounted"}),"\n",(0,t.jsx)(n.li,{children:"Remove dynamic targeting and key-values from the previous page"}),"\n",(0,t.jsx)(n.li,{children:"Add dynamic targeting and key-values for the new page"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"solution",children:"Solution"}),"\n",(0,t.jsx)(n.p,{children:"On a server-side rendered website ad loading is either triggered by"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["a config setting ",(0,t.jsx)(n.code,{children:"requestAds: true"})," in the ",(0,t.jsx)(n.code,{children:"moliConfig"})," or"]}),"\n",(0,t.jsxs)(n.li,{children:["by calling ",(0,t.jsx)(n.code,{children:"window.moli.requestAds()"})," in the JavaScript code if is ",(0,t.jsx)(n.code,{children:"requestAds: false"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["On a single page application, you ",(0,t.jsx)(n.strong,{children:"always"})," have to call ",(0,t.jsx)(n.code,{children:"window.moli.requestAds()"}),". The first time the page is loaded\nand after every page navigation. It tries to mimic a real page refresh and handles all cases mentioned above. All\njavascript frameworks that support client-side rendering have route change events that you can hook into."]}),"\n",(0,t.jsxs)(n.p,{children:["The second part is that you have to refresh the ad slots after the necessary component is mounted. This is usually done\nby implementing an ",(0,t.jsx)(n.code,{children:"Ad"})," component that calls ",(0,t.jsx)(n.code,{children:"window.moli.refreshAdSlot('div-id')"})," in the ",(0,t.jsx)(n.code,{children:"componentDidMount"})," lifecycle\nor ",(0,t.jsx)(n.code,{children:"useEffect"})," hook."]}),"\n",(0,t.jsx)(n.p,{children:"A very basic ad component may look like this:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-tsx",children:"import React, { useEffect } from 'react';\n\nconst Ad = ({ id }) => {\n  useEffect(() => {\n    window.moli.refreshAdSlot(id);\n  }, [id]);\n\n  return <div id={id} />;\n};\n"})}),"\n",(0,t.jsx)(n.h2,{id:"state-management",children:"State Management"}),"\n",(0,t.jsx)(n.p,{children:"It's a lot easier to mess up refreshing ad slots in an SPA than on a server-side rendered website. Refreshing ad slots\nmultiple times can happy by accident due to unexpected re-renders. This behaviour should be avoided at all costs as it\ndevalues the ad inventory and can be classified as ad fraud."}),"\n",(0,t.jsxs)(n.p,{children:["The default ",(0,t.jsx)(n.code,{children:"spa"})," configuration looks like this"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"const moliConfig: Moli.Config = {\n  slots: [ /* ... */],\n  requestAds: false,\n  // highlight-start\n  spa: {\n    enabled: true,\n    validateLocation: 'href'\n  },\n  // highlight-end\n};\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"validateLocation"})," property defines what URL change determines a page navigation. The default value is ",(0,t.jsx)(n.code,{children:"'href'"}),".\nPossible configuration values are"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"'href'"})," - The full URL changes (default)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"'pathname'"})," - Only the path changes. Use this if you use query params and anchors that do not change the actual page.\nA common example are filter parameters in a shop or cursor parameters in an infinite list."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"'none'"})," - Nothing is checked \u26a0 not recommended. There are no safeguards at all"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Here is ",(0,t.jsx)(n.a,{href:"/moli-ad-tag/docs/api/types/moliConfig/namespaces/spa/interfaces/SinglePageAppConfig#validatelocation",children:"the full documentation of all values"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"The definition of a navigation change is important for basic safeguards"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"moli.requestAds()"})," can only be called once per page navigation. This ensures that ad slots are not created and\ndestroyed multiple times and targeting state is not overridden or lost."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"moli.refreshAdSlot()"}),", ",(0,t.jsx)(n.code,{children:"moli.refreshInfiniteAdSlot()"}),", ",(0,t.jsx)(n.code,{children:"moli.refreshBucket()"})," either queues the refresh call or directly refreshes the ad slot."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"requestads",children:"requestAds"}),"\n",(0,t.jsxs)(n.p,{children:["You should call ",(0,t.jsx)(n.code,{children:"window.moli.requestAds()"})," after every page navigation. This ensures that all ad slots are removed and\nstate is reset. It also refreshes all ad slots that have been queued through ",(0,t.jsx)(n.code,{children:"moli.refreshAdSlot()"}),", ",(0,t.jsx)(n.code,{children:"moli.refreshInfiniteAdSlot()"})," or ",(0,t.jsx)(n.code,{children:"moli.refreshBucket()"})," calls."]}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["If you have page view tracking in place, then call ",(0,t.jsx)(n.code,{children:"requestAds()"})," at the exact place as these two calls should match."]})}),"\n",(0,t.jsx)(n.h3,{id:"refreshadslot--refreshinfiniteadslot--refreshbucket",children:"refreshAdSlot / refreshInfiniteAdSlot / refreshBucket"}),"\n",(0,t.jsxs)(n.p,{children:["The refresh calls have two response types: ",(0,t.jsx)(n.code,{children:"queued"})," and ",(0,t.jsx)(n.code,{children:"refreshed"}),". The response depends on the ",(0,t.jsx)(n.code,{children:"validateLocation"}),",\nthe current navigation state and if ",(0,t.jsx)(n.code,{children:"requestAds()"})," has already been called. This examples demonstrates a common scenario."]}),"\n",(0,t.jsxs)(n.p,{children:["Configuration: ",(0,t.jsx)(n.code,{children:"validateLocation: 'href'"})]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"URL"}),(0,t.jsx)(n.th,{children:(0,t.jsx)(n.code,{children:"requestAds()"})}),(0,t.jsx)(n.th,{children:(0,t.jsx)(n.code,{children:"refreshAdSlot()"})}),(0,t.jsx)(n.th,{children:"Response"}),(0,t.jsx)(n.th,{children:"Explanation"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"/home"}),(0,t.jsx)(n.td,{children:"not called"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"div-id"})}),(0,t.jsx)(n.td,{children:"queued"}),(0,t.jsxs)(n.td,{children:["waiting for ",(0,t.jsx)(n.code,{children:"requestAds()"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"/home"}),(0,t.jsx)(n.td,{children:"called"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"div-id"})}),(0,t.jsx)(n.td,{children:"refreshed"}),(0,t.jsx)(n.td,{children:"still on the same page. Ad slot can be refreshed immediately"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"/profile"}),(0,t.jsx)(n.td,{children:"not called"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"div-id"})}),(0,t.jsx)(n.td,{children:"queued"}),(0,t.jsx)(n.td,{children:"user has navigated to a new page. Ad slot is queued"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"/profile"}),(0,t.jsx)(n.td,{children:"called"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"div-id"})}),(0,t.jsx)(n.td,{children:"refreshed"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"requestAds()"})," has been called. Queued slots are refreshed and all subsequeuent calls are refreshed immediatly"]})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"addlabel--settargeting",children:"addLabel / setTargeting"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"addLabel"})," and ",(0,t.jsx)(n.code,{children:"setTargeting"})," calls are not affected directly by the ",(0,t.jsx)(n.code,{children:"validateLocation"})," setting. Every ",(0,t.jsx)(n.code,{children:"requestAds()"}),"\npersists the labels and targeting values set for the current page. All subsequent ",(0,t.jsx)(n.code,{children:"addLabel"})," and ",(0,t.jsx)(n.code,{children:"setTargeting"})," calls\nare stored for the next ",(0,t.jsx)(n.code,{children:"requestAds()"})," call."]}),"\n",(0,t.jsxs)(n.admonition,{type:"tip",children:[(0,t.jsxs)(n.p,{children:["Labels and targeting key-values from the ",(0,t.jsx)(n.code,{children:"MoliConfig"})," are permanent. If you need permanent labels or targeting key values\nyou have to set them again before every ",(0,t.jsx)(n.code,{children:"requestAds()"})," call. We recommend doing this on the publisher side, directly before\nthe ",(0,t.jsx)(n.code,{children:"requestAds()"})," call, e.g."]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"window.moli.addLabel('mobile');\nwindow.moli.setTargeting('key', 'value');\nwindow.moli.requestAds();\n"})}),(0,t.jsxs)(n.p,{children:["The other option is the ",(0,t.jsx)(n.code,{children:"beforeRequestAds()"})," hook that is called before every ",(0,t.jsx)(n.code,{children:"requestAds()"})," call."]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"window.moli.beforeRequestAds(() => {\n  window.moli.addLabel('mobile');\n  window.moli.setTargeting('key', 'value');\n});\n"})})]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}}}]);