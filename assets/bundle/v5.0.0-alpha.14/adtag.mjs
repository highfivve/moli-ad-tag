const parseQueryParameter=e=>{const t=e.indexOf("=");if(t>=0){return[decodeURIComponent(e.slice(0,t)),decodeURIComponent(e.slice(t+1))]}return[decodeURIComponent(e),""]},parseQueryString=e=>{try{const t=e.startsWith("?")?e.slice(1):e;return t.length>0?new Map(t.split("&").filter((e=>e.length>0)).map(parseQueryParameter)):new Map}catch(e){return console.error(e),new Map}};var domready=(e,t)=>{let i,o=[],s="object"==typeof e.document&&e.document,r=s&&s.documentElement.doScroll,n="DOMContentLoaded",a=s&&(r?/^loaded|^c/:/^loaded|^i|^c/).test(s.readyState);!a&&s&&s.addEventListener(n,i=()=>{if(s)for(s.removeEventListener(n,i),a=!0;i=o.shift();)i()}),a?setTimeout(t,0):o.push(t)},AssetLoadMethod;!function(e){e[e.FETCH=0]="FETCH",e[e.TAG=1]="TAG"}(AssetLoadMethod||(AssetLoadMethod={}));class AssetLoaderService{constructor(e){this.window=e}loadScript(e,t=this.window.document.head){return this.awaitDomReady().then((()=>{switch(e.loadMethod){case AssetLoadMethod.FETCH:return this.loadAssetViaFetch(e,t);case AssetLoadMethod.TAG:return this.loadAssetViaTag(e,t)}}))}loadJson(e,t){return this.window.fetch(t,{method:"GET",mode:"cors",headers:{"Content-Type":"application/json"}}).then((e=>e.ok?e.json():e.text().then((t=>Promise.reject(`${e.statusText}: ${t}`))))).catch((e=>Promise.reject(e)))}loadAssetViaFetch(e,t){return this.window.fetch(e.assetUrl).then((e=>e.ok?Promise.resolve(e):Promise.reject(e))).then((e=>e.text())).then((e=>this.scriptTagWithBody(e))).then((e=>t.appendChild(e)))}scriptTagWithBody(e){const t=this.window.document.createElement("script");return t.type="text/javascript",t.async=!0,t.text=e,t}loadAssetViaTag(e,t){const i=this.scriptTagWithSrc(e.assetUrl);return new Promise(((e,o)=>{i.onload=e,i.onerror=o,t.appendChild(i)}))}scriptTagWithSrc(e){const t=this.window.document.createElement("script");return t.type="text/javascript",t.async=!0,t.src=e,t}awaitDomReady(){return new Promise((e=>{domready(this.window,e)}))}}const createAssetLoaderService=e=>new AssetLoaderService(e);function getMoliDebugParameter(e){try{const t="moliDebug";return!!parseQueryString(e.location.search).get(t)||!!e.sessionStorage.getItem(t)||!!e.localStorage.getItem(t)}catch(e){return!1}}function getNoopLogger(){const e=()=>{};return{debug:e,info:e,warn:e,error:console.error}}function getLabelStyle(e){return`background:${e}; color:#FFF; padding:3px; margin:3px; border-radius:5px; line-height: 15px;`}function getLogStageLabelStyle(e){switch(e){case"debug":return getLabelStyle("#49A0CC");case"info":return getLabelStyle("#61A172");case"warn":return getLabelStyle("#FFC300");case"error":return getLabelStyle("#C70039")}}function getSourceLabelStyle(e){switch(e){case"AdPipeline":return getLabelStyle("#74ABC6");case"GAM":return getLabelStyle("#BA0E5F");case"Faktor CMP":return getLabelStyle("#9374C6");case"MoliGlobal":return getLabelStyle("#403073");case"Prebid":return getLabelStyle("#4357AD");case"AdVisibilityService":return getLabelStyle("#d5ba3c");case"UserActivityService":return getLabelStyle("#19ad0e");case"Adex DMP":return getLabelStyle("#003E74");default:return getLabelStyle("#052E53")}}function getDefaultLogger(){return{debug(e,t,...i){console.debug(`%c[DEBUG]%c${e}%c${t}`,getLogStageLabelStyle("debug"),getSourceLabelStyle(e),"",...i)},info(e,t,...i){console.info(`%c[INFO]%c${e}%c${t}`,getLogStageLabelStyle("info"),getSourceLabelStyle(e),"",...i)},warn(e,t,...i){console.warn(`%c[WARN]%c${e}%c${t}`,getLogStageLabelStyle("warn"),getSourceLabelStyle(e),"",...i)},error(e,t,...i){console.error(`%c[ERROR]%c${e}%c${t}`,getLogStageLabelStyle("error"),getSourceLabelStyle(e),"",...i)}}}function getLogger(e,t){return getMoliDebugParameter(t)?getDefaultLogger():e&&e.logger?e.logger:getNoopLogger()}class ProxyLogger{constructor(e){this.logger=e,this.setLogger=e=>{this.logger=e}}debug(e,...t){this.logger.debug(e,...t)}error(e,...t){this.logger.error(e,...t)}info(e,...t){this.logger.info(e,...t)}warn(e,...t){this.logger.warn(e,...t)}}const addNewInfiniteSlotToConfig=(e,t,i,o)=>{const s=e.slots.find((e=>e.domId===t));if(s){const t={...s,domId:i};return{...e,slots:[...e.slots,t]}}return o.error("MoliGlobal","no infinite ad slot configured!",e),e};function flatten(e){return e.reduce(((e,t)=>e.concat(t)),[])}function uniquePrimitiveFilter(e,t,i){return i.indexOf(e)===t}function isNotNull(e){return null!=e}class LabelConfigService{constructor(e,t,i){this.labelSizeConfig=e,this.extraLabels=t,this.window=i,this.possibleDevices=["mobile","desktop","android","ios"];const o=t.some((e=>this.possibleDevices.indexOf(e)>-1)),s=e.filter((e=>i.matchMedia(e.mediaQuery).matches));this.isValid=0===e.length||!(e.length>0&&0===s.length);const r=flatten(s.map((e=>e.labelsSupported)));this.supportedLabels=[...o?[]:r,...t].filter(uniquePrimitiveFilter)}filterSlot(e){let t=!0;return this.supportedLabels.length&&e.labelAll?.length&&(t=e.labelAll.every((e=>this.supportedLabels.indexOf(e)>-1))),this.supportedLabels.length&&e.labelAny&&!e.labelAll?.length&&(t=e.labelAny.some((e=>this.supportedLabels.indexOf(e)>-1))),t}getSupportedLabels(){return this.supportedLabels}getDeviceLabel(){return this.getSupportedLabels().find((e=>this.possibleDevices.indexOf(e)>-1))||"mobile"}}var tcfapi;!function(e){var t,i,o,s;(function(e){e[e.STORE_INFORMATION_ON_DEVICE=1]="STORE_INFORMATION_ON_DEVICE",e[e.SELECT_BASIC_ADS=2]="SELECT_BASIC_ADS",e[e.CREATE_PERSONALISED_ADS_PROFILE=3]="CREATE_PERSONALISED_ADS_PROFILE",e[e.SELECT_PERSONALISED_ADS=4]="SELECT_PERSONALISED_ADS",e[e.CREATE_PERSONALISED_CONTENT_PROFILE=5]="CREATE_PERSONALISED_CONTENT_PROFILE",e[e.SELECT_PERSONALISED_CONTENT=6]="SELECT_PERSONALISED_CONTENT",e[e.MEASURE_AD_PERFORMANCE=7]="MEASURE_AD_PERFORMANCE",e[e.MEASURE_CONTENT_PERFORMANCE=8]="MEASURE_CONTENT_PERFORMANCE",e[e.APPLY_MARKET_RESEARCH=9]="APPLY_MARKET_RESEARCH",e[e.DEVELOP_IMPROVE_PRODUCTS=10]="DEVELOP_IMPROVE_PRODUCTS"})((t=e.responses||(e.responses={})).TCPurpose||(t.TCPurpose={})),(i=t.RestrictionType||(t.RestrictionType={}))[i.NOT_ALLOWED=0]="NOT_ALLOWED",i[i.REQUIRE_CONSENT=1]="REQUIRE_CONSENT",i[i.REQUIRE_LI=2]="REQUIRE_LI",o=e.status||(e.status={}),(s=o.DisplayStatus||(o.DisplayStatus={})).VISIBLE="visible",s.HIDDEN="hidden",s.DISABLED="disabled",function(e){e.STUB="stub",e.LOADING="loading",e.LOADED="loaded",e.ERROR="error"}(o.CmpStatus||(o.CmpStatus={})),function(e){e.TC_LOADED="tcloaded",e.CMP_UI_SHOWN="cmpuishown",e.USER_ACTION_COMPLETE="useractioncomplete"}(o.EventStatus||(o.EventStatus={}))}(tcfapi||(tcfapi={}));var EventStatus=tcfapi.status.EventStatus,CmpStatus=tcfapi.status.CmpStatus;const allPurposes=[tcfapi.responses.TCPurpose.STORE_INFORMATION_ON_DEVICE,tcfapi.responses.TCPurpose.SELECT_BASIC_ADS,tcfapi.responses.TCPurpose.CREATE_PERSONALISED_ADS_PROFILE,tcfapi.responses.TCPurpose.SELECT_PERSONALISED_ADS,tcfapi.responses.TCPurpose.CREATE_PERSONALISED_CONTENT_PROFILE,tcfapi.responses.TCPurpose.SELECT_PERSONALISED_CONTENT,tcfapi.responses.TCPurpose.MEASURE_AD_PERFORMANCE,tcfapi.responses.TCPurpose.MEASURE_CONTENT_PERFORMANCE,tcfapi.responses.TCPurpose.APPLY_MARKET_RESEARCH,tcfapi.responses.TCPurpose.DEVELOP_IMPROVE_PRODUCTS],missingPurposeConsent=e=>!!e.gdprApplies&&allPurposes.some((t=>!e.purpose.consents[t]&&e.purpose.legitimateInterests[t])),consentReady=(e,t,i,o)=>("test"===o&&i.info("gdprApplies is set to false in test mode!"),"test"===o||!1===e.enabled?Promise.resolve({gdprApplies:!1,eventStatus:EventStatus.TC_LOADED,cmpStatus:CmpStatus.LOADED,cmpId:0,cmpVersion:0,tcfPolicyVersion:void 0,listenerId:null}):new Promise(((o,s)=>{if(t.__tcfapi){const r=r=>{"error"===r.cmpStatus?s(r):"useractioncomplete"!==r.eventStatus&&"tcloaded"!==r.eventStatus||(i.debug("Consent","consent ready",r),e.disableLegitimateInterest&&missingPurposeConsent(r)?s("user consent is missing for some purposes"):o(r),r.listenerId&&t.__tcfapi("removeEventListener",2,(()=>{}),r.listenerId))};t.__tcfapi("addEventListener",2,r)}else s("window.__tcfapi is not defined. Make sure that the stub code is inlined in the head tag")}))),extractTopPrivateDomainFromHostname=e=>{if(e){const[t,i,o]=e.split(".").reverse();switch(`${i}.${t}`){case"co.uk":case"com.br":case"com.mx":case"com.au":return`${o}.${i}.${t}`;default:return i?`${i}.${t}`:t}}},removeChildId=e=>{const[t,i,...o]=e.split("/"),[s,...r]=i.split(",");return 0===r.length?e:["",s,...o].join("/")},resolveAdUnitPath$1=(e,t)=>{const i=/([A-Za-z0-9\_]+)/g,o=e.match(/[^{]+(?=})/g);return t&&o?(o.forEach((e=>{if(!e.match(i))throw new SyntaxError(`invalid variable "${e}" in path`);if(!t[e])throw new ReferenceError(`path variable "${e}" is not defined`)})),e.replace(new RegExp(Object.keys(t).map((e=>`{${e}}`)).join("|"),"g"),(e=>t[e.substr(1,e.length-2)]))):e},withDepth=(e,t)=>e.split("/").slice(0,t+1).join("/"),generateAdUnitPathVariables=(e,t,i,o)=>({device:t,domain:o||extractTopPrivateDomainFromHostname(e)||"unknown",...i});var TCPurpose$3=tcfapi.responses.TCPurpose;const HIGH_PRIORITY=100,LOW_PRIORITY=10,mkInitStep=(e,t)=>(Object.defineProperty(t,"name",{value:e}),t),mkConfigureStep=(e,t)=>(Object.defineProperty(t,"name",{value:e}),t),mkConfigureStepOncePerRequestAdsCycle=(e,t)=>{Object.defineProperty(t,"name",{value:e});let i=0;return mkConfigureStep(e,((e,o)=>i!==e.requestAdsCalls?(i=e.requestAdsCalls,t(e,o)):Promise.resolve()))},mkConfigureStepOnce=(e,t)=>(Object.defineProperty(t,"name",{value:e}),mkConfigureStep(e,((e,i)=>1===e.requestAdsCalls&&1===e.requestId?t(e,i):Promise.resolve()))),mkPrepareRequestAdsStep=(e,t,i)=>{const o=Object.assign(i,{priority:t});return Object.defineProperty(i,"name",{value:e}),o},mkRequestBidsStep=(e,t)=>(Object.defineProperty(t,"name",{value:e}),t);class AdPipeline{constructor(e,t,i,o){this.config=e,this.logger=t,this.window=i,this.auction=o,this.init=null,this.tcData=null,this.requestId=0,this.runPrepareRequestAds=(e,t)=>{const i=new Map;return this.config.prepareRequestAds.forEach((e=>{const t=i.get(e.priority);t?t.push(e):i.set(e.priority,[e])})),Array.from(i.entries()).sort((([e],[t])=>e>t?-1:1)).reduce(((i,[o,s])=>i.then((()=>(e.logger.debug("AdPipeline",e.requestId,`run prepareRequestAds with priority ${o}`),Promise.all(s.map((i=>i(e,t)))))))),Promise.resolve(void 0))}}run(e,t,i,o,s){if(0===e.length)return Promise.resolve();this.requestId=this.requestId+1;const r=this.requestId;this.logger.debug("AdPipeline",`starting run with requestId ${r} on ${o}. call`,e);const n=t.consent||{};return this.tcData=this.tcData?this.tcData:consentReady(n,this.window,this.logger,i.environment),this.tcData.then((n=>{const a=[...t.targeting?.labels||[]];n.gdprApplies&&n.purpose.consents[TCPurpose$3.STORE_INFORMATION_ON_DEVICE]?a.push("purpose-1"):n.gdprApplies||a.push("purpose-1");const d=new LabelConfigService(t.labelSizeConfig||[],a,this.window),l=s&&t.buckets?.bucket&&t.buckets.bucket[s]?t.buckets.bucket[s]:null,u=generateAdUnitPathVariables(this.window.location.hostname,d.getDeviceLabel(),t.targeting?.adUnitPathVariables,t.domain),c={requestId:r,requestAdsCalls:o,logger:this.logger,env:i.environment||"production",config:t,runtimeConfig:i,labelConfigService:d,window:this.window,tcData:n,bucket:l,adUnitPathVariables:u,auction:this.auction};this.init=this.init?this.init:this.logStage("init",r).then((()=>Promise.all(this.config.init.map((e=>e(c))))));const g="rejected-no-slots-after-filtering";return this.init.then((()=>this.logStage("configure",r).then((()=>Promise.all(this.config.configure.map((t=>t(c,e)))))))).then((()=>this.logStage("defineSlots",r).then((()=>this.config.defineSlots(c,e))))).then((e=>e.length?this.logStage("prepareRequestAds",r).then((()=>this.runPrepareRequestAds(c,e))).then((()=>this.logStage("requestBids",r))).then((()=>Promise.all(this.config.requestBids.map((t=>t(c,e)))))).then((()=>this.logStage("requestAds",r))).then((()=>this.config.requestAds(c,e))):Promise.reject(g))).catch((e=>e===g?Promise.resolve():(this.logger.error("AdPipeline","running ad pipeline failed with error",e),Promise.reject(e))))}))}getAuction(){return this.auction}logStage(e,t){return new Promise((i=>{this.logger.debug("AdPipeline",t,`stage: ${e}`),i()}))}}const isSizeEqual=(e,t)=>e[0]===t[0]&&e[1]===t[1];class SizeConfigService{static isFixedSize(e){return"fluid"!==e}constructor(e,t,i){this.sizeConfig=e,this.supportedLabels=t,this.window=i,this.filterSupportedSizes=e=>this.isValid?0===this.supportedSizes.length?e:this.supportedSizes.filter((t=>e.some((e=>"fluid"===t?"fluid"===e:"fluid"!==e&&isSizeEqual(e,t))))):[],this.areLabelsMatching=(e,t)=>(!e.labelAll||e.labelAll.every((e=>t.some((t=>t===e)))))&&(!e.labelNone||!e.labelNone.some((e=>t.some((t=>t===e)))));const o=0!==e.length?e.filter((e=>i.matchMedia(e.mediaQuery).matches&&this.areLabelsMatching(e,t))):[];this.isValid=0===e.length||!(e.length>0&&0===o.length),this.supportedSizes=flatten(o.map((e=>e.sizesSupported))).map((e=>JSON.stringify(e))).filter(uniquePrimitiveFilter).map((e=>JSON.parse(e)))}filterSlot(e){return!e.sizes||0===e.sizes.length||this.filterSupportedSizes(e.sizes).length>0}}const BrowserStorageKeys={moliEnv:"moli-env",moliPubCode:"moli-pub-code",moliVersion:"moli-version",testSlotSize:e=>`moli-test-slot-size-${e}`,debugDelay:"moli-debug-delay"},getBrowserStorageValue=(e,t=localStorage)=>{try{return t.getItem(e)}catch(i){return getDefaultLogger().debug(`Could not read value with key ${e} from browser storage`,t),null}},setBrowserStorageValue=(e,t,i=localStorage)=>{try{i.setItem(e,t)}catch(o){getDefaultLogger().debug(`Could not set key ${e} with value ${t} to browser storage`,i)}},isTestSlotSize=e=>"hidden"===e||Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1],testSlotContainerId=e=>`${e}__container`,createTestSlots=(e,t)=>{const i=createBlankTestSlots(e,t);return i.forEach((({slot:e,container:t})=>{t.innerHTML="",t.appendChild(testSlotContent(e))})),i},setContent=(e,t)=>{const i=document.getElementById(e);i&&(i.innerHTML=t)},createBlankTestSlots=(e,t)=>(t.forEach((t=>{const{moliSlot:i}=t,o=testSlotContainerId(i.domId),s=document.createElement("div");s.id=o;const r=document.getElementById(i.domId);r&&r.setAttribute("data-google-query-id","test"),setContent(i.domId,s.outerHTML),e.logger.debug("GAM",`Set content for slot: [DomID] ${i.domId} [AdUnitPath] ${i.adUnitPath}`)})),queryTestSlots(t)),queryTestSlots=e=>e.map((e=>{const t=document.getElementById(testSlotContainerId(e.moliSlot.domId));return t?{slot:e,container:t}:void 0})).filter(isNotNull),testSlotContent=e=>{const t=getSizesForSlot(e),i=pickTestSlotSize(e.moliSlot,t);if("hidden"===i)return document.createElement("div");{const o=document.createElement("div"),[s,r]=i;o.style.cssText=`\n      position: relative; display: inline-flex; flex-direction: column; align-items: center; justify-content: center;\n      width: ${s}px; height: ${r}px; padding: 6px; border: 2px dotted gray; background-color: #fff;\n      background-image: linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px), linear-gradient(#eee .1em, transparent .1em);\n      background-size: 100% 1.2em; box-sizing: border-box;\n    `;const n=document.createElement("h4");n.innerHTML=`<strong>${e.moliSlot.domId}</strong>`,o.appendChild(n);const a=document.createElement("span");a.style.color="#656565";const d=([e,t])=>a.innerText=`(${e}x${t})`;d([s,r]),n.appendChild(a);const l=document.createElement("div");l.style.cssText="position: absolute; top: 5px; left: 5px",o.appendChild(l);const u=(t,i)=>{if("hidden"===t)o.style.display="none";else{const[e,s]=t;o.style.width=`${e}px`,o.style.height=`${s}px`,d(t),f(i)}saveSizeInLocalStorage(e.moliSlot,t)},c="1px dotted white",g="1px solid black",p=document.createElement("button");p.innerText="hide",p.title="Once hidden, it can only be restored using the moli console (or by clearing local storage manually)",p.style.cssText=`font-size: 10px; background: #656565; color: white; width: auto important!; border: ${c};`,p.addEventListener("click",(()=>u("hidden",p)));const h=[...t.map((e=>{const[t,o]=e,s=equalsSize(i,e),r=document.createElement("button");return r.innerText=`${t}x${o}`,r.style.cssText=`font-size: 10px; background: #00a4a6; color: white; width: auto important!; border: ${s?g:c};`,r.addEventListener("click",(()=>u(e,r))),r})),p];h.forEach((e=>l.appendChild(e)));const f=e=>{h.forEach((e=>e.style.border=c)),e.style.border=g};return o}},getSizesForSlot=e=>e.filterSupportedSizes(e.moliSlot.sizes).filter(SizeConfigService.isFixedSize).filter((([e,t])=>e>1&&t>1)),pickTestSlotSize=(e,t)=>{const i=getSizeFromLocalStorage(e);if(i&&("hidden"===i||includesSize(t,i)))return i;{const e=Math.floor(Math.random()*t.length);return 0===t.length?[300,250]:t[e]}},saveSizeInLocalStorage=(e,t)=>setBrowserStorageValue(BrowserStorageKeys.testSlotSize(e.domId),JSON.stringify(t)),getSizeFromLocalStorage=e=>{const t=getBrowserStorageValue(BrowserStorageKeys.testSlotSize(e.domId));if(t)try{const e=JSON.parse(t);return isTestSlotSize(e)?e:void 0}catch{return}},equalsSize=(e,t)=>{const[i,o]=e,[s,r]=t;return i===s&&o===r},includesSize=(e,t)=>e.some((e=>equalsSize(e,t)));var TCPurpose$2=tcfapi.responses.TCPurpose;const testAdSlot=(e,t)=>({setCollapseEmptyDiv(){},addService(e){},getSlotElementId:()=>e,getAdUnitPath:()=>t,setTargeting(e,t){return this},getTargeting:e=>[],getTargetingKeys:()=>[],clearTargeting(e){},getResponseInformation:()=>null}),configureTargeting=(e,t,i)=>{const o=i?i.keyValues:{},s=i?.adManagerExcludes??[];[o,t].forEach((t=>{Object.keys(t).filter((e=>!s.includes(e))).forEach((i=>{const o=t[i];o&&e.googletag.pubads().setTargeting(i,o)}))}))},useStandardGpt=(e,t)=>!1===t?.useLimitedAds||(!e.gdprApplies||e.vendor.consents[755]&&e.purpose.consents[TCPurpose$2.STORE_INFORMATION_ON_DEVICE]&&[TCPurpose$2.SELECT_BASIC_ADS,TCPurpose$2.MEASURE_AD_PERFORMANCE,TCPurpose$2.APPLY_MARKET_RESEARCH,TCPurpose$2.DEVELOP_IMPROVE_PRODUCTS].every((t=>e.purpose.consents[t]||e.purpose.legitimateInterests[t]))),gptInit=e=>{let t;return mkInitStep("gpt-init",(i=>"test"===i.env?Promise.resolve():(t||(t=new Promise((t=>{i.logger.debug("GAM","init googletag stub"),i.window.googletag=i.window.googletag||{},i.window.googletag.cmd=i.window.googletag.cmd||[],i.window.googletag.cmd.push(t),e.loadScript({name:"gpt",loadMethod:AssetLoadMethod.TAG,assetUrl:useStandardGpt(i.tcData,i.config.consent)?"https://securepubads.g.doubleclick.net/tag/js/gpt.js":"https://pagead2.googlesyndication.com/tag/js/gpt.js"}).catch((e=>i.logger.error("failed to load gpt.js",e)))}))),t)))},gptDestroyAdSlots=()=>{let e=0;return mkConfigureStep("gpt-destroy-ad-slots",((t,i)=>{if("test"===t.env)return Promise.resolve();if(!1===t.config.spa?.destroyAllAdSlots){const e=t.window.googletag.pubads().getSlots(),o=i.map((t=>e.find((e=>e.getSlotElementId()===t.domId)))).filter(isNotNull);0===o.length?t.logger.debug("GAM","no ad slots to destroy"):(t.logger.debug("GAM",`destroy ${o.length} ad slots`,o),t.window.googletag.destroySlots(o))}else e!==t.requestAdsCalls&&(e=t.requestAdsCalls,t.logger.debug("GAM","destroy all ad slots"),t.window.googletag.destroySlots());return Promise.resolve()}))},gptResetTargeting=()=>mkConfigureStepOncePerRequestAdsCycle("gpt-reset-targeting",(e=>new Promise((t=>{"production"===e.env&&(e.logger.debug("GAM","reset top level targeting"),e.window.googletag.pubads().clearTargeting(),configureTargeting(e.window,e.runtimeConfig.keyValues,e.config.targeting)),t()})))),gptConfigure=()=>{let e;return mkConfigureStep("gpt-configure",((t,i)=>(e||(e=new Promise((e=>{const i=t.runtimeConfig.environment||"production";switch(t.logger.debug("GAM","configure googletag"),i){case"production":configureTargeting(t.window,t.runtimeConfig.keyValues,t.config.targeting),t.window.googletag.pubads().enableAsyncRendering(),t.window.googletag.pubads().disableInitialLoad(),t.window.googletag.pubads().enableSingleRequest();const i=!useStandardGpt(t.tcData,t.config.consent);return t.logger.debug("GAM","use limited ads",i),t.window.googletag.pubads().setPrivacySettings({limitedAds:i}),t.window.googletag.enableServices(),void e();case"test":return void e()}}))),e)))},gptLDeviceLabelKeyValue=()=>mkPrepareRequestAdsStep("gpt-device-label-keyValue",LOW_PRIORITY,(e=>"test"===e.env?Promise.resolve():new Promise((t=>{const i=e.labelConfigService.getDeviceLabel();e.logger.debug("GAM",'adding "device_label" key-value with values',i),e.window.googletag.pubads().setTargeting("device_label",i),t()})))),gptConsentKeyValue=()=>mkPrepareRequestAdsStep("gpt-consent-keyValue",LOW_PRIORITY,(e=>"test"===e.env?Promise.resolve():new Promise((t=>{const i=e.tcData,o=!i.gdprApplies||[TCPurpose$2.STORE_INFORMATION_ON_DEVICE,TCPurpose$2.SELECT_BASIC_ADS,TCPurpose$2.CREATE_PERSONALISED_ADS_PROFILE,TCPurpose$2.SELECT_PERSONALISED_ADS,TCPurpose$2.CREATE_PERSONALISED_CONTENT_PROFILE,TCPurpose$2.SELECT_PERSONALISED_CONTENT,TCPurpose$2.MEASURE_AD_PERFORMANCE,TCPurpose$2.MEASURE_CONTENT_PERFORMANCE,TCPurpose$2.APPLY_MARKET_RESEARCH,TCPurpose$2.DEVELOP_IMPROVE_PRODUCTS].every((e=>i.purpose.consents[e]));e.window.googletag.pubads().setTargeting("consent",o?"full":"none"),t()})))),gptDefineSlots=()=>(e,t)=>{const i=t.map((t=>{const i=new SizeConfigService(t.sizeConfig,e.labelConfigService.getSupportedLabels(),e.window),o=i.filterSupportedSizes;if(!i.filterSlot(t)||!e.labelConfigService.filterSlot(t))return Promise.resolve(null);const s=o(t.sizes),r=resolveAdUnitPath$1(t.adUnitPath,e.adUnitPathVariables),n=("test"===e.env?[]:e.window.googletag.pubads().getSlots()).find((e=>e.getSlotElementId()===t.domId)),a=n||(()=>{if("test"===e.env)return null;const i=(()=>{switch(t.position){case"in-page":return e.window.googletag.defineSlot(r,s,t.domId);case"out-of-page":return e.window.googletag.defineOutOfPageSlot(r,t.domId);case"out-of-page-interstitial":return e.logger.debug("GAM",`defined web interstitial for ${r}`),e.window.googletag.defineOutOfPageSlot(r,e.window.googletag.enums.OutOfPageFormat.INTERSTITIAL);case"out-of-page-bottom-anchor":return e.logger.debug("GAM",`defined bottom anchor for ${r}`),e.window.googletag.defineOutOfPageSlot(r,e.window.googletag.enums.OutOfPageFormat.BOTTOM_ANCHOR);case"out-of-page-top-anchor":return e.logger.debug("GAM",`defined top anchor for ${r}`),e.window.googletag.defineOutOfPageSlot(r,e.window.googletag.enums.OutOfPageFormat.TOP_ANCHOR)}})();return i&&e.window.googletag.display(i),i})();switch(e.env){case"production":if(a)return a.setCollapseEmptyDiv(!1!==t.gpt?.collapseEmptyDiv),a.addService(e.window.googletag.pubads()),e.logger.debug("GAM",`Register slot: [DomID] ${t.domId} [AdUnitPath] ${t.adUnitPath}`),Promise.resolve({moliSlot:t,adSlot:a,filterSupportedSizes:o});if("out-of-page-interstitial"===t.position||"out-of-page-top-anchor"===t.position||"out-of-page-bottom-anchor"===t.position)return e.logger.warn("GAM",`${t.position} is not supported`),Promise.resolve(null);{const i=`Slot: [DomID] ${t.domId} [AdUnitPath] ${t.adUnitPath} is already defined. You may have called requestAds() multiple times`;return e.logger.error("GAM",i),Promise.reject(new Error(i))}case"test":return Promise.resolve({moliSlot:t,adSlot:testAdSlot(t.domId,t.adUnitPath),filterSupportedSizes:o});default:return Promise.reject(`invalid environment: ${e.runtimeConfig.environment}`)}}));return Promise.all(i).then((e=>e.filter(isNotNull)))},gptRequestAds=()=>(e,t)=>new Promise((i=>{switch(e.logger.debug("GAM","requestAds"),e.env){case"test":createTestSlots(e,t);break;case"production":const i=t.filter((({moliSlot:t})=>!e.auction.isSlotThrottled(t.domId)));if(0===i.length)break;e.window.googletag.pubads().refresh(i.map((({adSlot:e})=>e)));const o=i.map((({moliSlot:e})=>`[DomID] ${e.domId} [AdUnitPath] ${e.adUnitPath}`)).join("\n");e.logger.debug("GAM",`Refresh ${t.length} slot(s):\n${o}`)}i()})),resolveStoredRequestIdInOrtb2Object=(e,t)=>({...e,ext:{...e.ext,prebid:{...e.ext?.prebid,storedrequest:t}}}),prebidTimeout=e=>new Promise(((t,i)=>{e.window.setTimeout((()=>i("Prebid did not resolve in time. Maybe you forgot to import the prebid distribution in the ad tag")),5e3)})),prebidInitAndReady=e=>new Promise((t=>{e.pbjs=e.pbjs||{que:[]},e.pbjs.que.push(t)})),isPrebidSlotDefinition=e=>!!e.moliSlot.prebid,isAdUnitDefined=(e,t)=>!!t.pbjs.adUnits&&t.pbjs.adUnits.some((t=>e.code===t.code)),createdAdUnits=(e,t,i)=>i.filter(isPrebidSlotDefinition).map((({moliSlot:i,priceRule:o,filterSupportedSizes:s})=>{const r=o?{floors:{currency:t.config.currency.adServerCurrency,schema:{delimiter:"|",fields:["mediaType"]},values:{"*":o.floorprice}}}:null;return e.logger.debug("Prebid",e.requestId,"Price Rule",o,i.domId,r),extractPrebidAdSlotConfigs(i.prebid).map((t=>{const o=t.adUnit.mediaTypes.banner,n=t.adUnit.mediaTypes.video,a=t.adUnit.mediaTypes.native,d=o?s(o.sizes).filter(SizeConfigService.isFixedSize):[],l=n?filterVideoPlayerSizes(n.playerSize,s):[],u=t.adUnit.bids.filter((t=>e.labelConfigService.filterSlot(t))).filter((t=>!t.bidder||!e.auction.biddersDisabling||!e.auction.biddersDisabling.isBidderDisabled(i.domId,t.bidder))).map((e=>{const{labelAny:t,labelAll:i,...o}=e;return o})),c=l.length>0&&!n?.w&&!n?.h?{w:l[0][0],h:l[0][1]}:{},g=n?{video:{...n,playerSize:0===l.length?void 0:l,...c}}:void 0,p=o&&d.length>0?{banner:{...o,sizes:d}}:void 0,h=a?{native:{...a}}:void 0,f={...t.adUnit.pubstack,adUnitPath:resolveAdUnitPath$1(t.adUnit.pubstack?.adUnitPath||i.adUnitPath,e.adUnitPathVariables)},m=t.adUnit.ortb2Imp?.ext?.prebid?.storedrequest,b=m&&m.id?{...m,id:resolveAdUnitPath$1(m.id,e.adUnitPathVariables)}:null;return{...t.adUnit,...m&&b&&{ortb2Imp:resolveStoredRequestIdInOrtb2Object(t.adUnit.ortb2Imp,b)},code:t.adUnit.code||i.domId,...t.adUnit.pubstack?{pubstack:f}:{},mediaTypes:{...g,...p,...h},bids:u,...r}})).filter((t=>t.bids.length>0&&t.mediaTypes&&(t.mediaTypes.banner||t.mediaTypes.video||t.mediaTypes.native)&&!isAdUnitDefined(t,e.window)))})).reduce(((e,t)=>[...e,...t]),[]),prebidInit=()=>mkInitStep("prebid-init",(e=>Promise.race([prebidInitAndReady(e.window),prebidTimeout(e)]))),prebidRemoveAdUnits=e=>mkConfigureStep("prebid-remove-adunits",(t=>new Promise((i=>{if(!0!==e.ephemeralAdUnits){t.window.pbjs=t.window.pbjs||{que:[]};const e=t.window.pbjs.adUnits;e&&(t.logger.debug("Prebid","Destroying prebid adUnits",e),e.forEach((e=>t.window.pbjs.removeAdUnit(e.code))))}i()})))),prebidConfigure=(e,t)=>{let i;const o=e=>({validation:"relaxed",config:{ver:"1.0",complete:1,nodes:e}});return mkConfigureStep("prebid-configure",((s,r)=>(i||(i=new Promise((i=>{e.bidderSettings&&(s.window.pbjs.bidderSettings=e.bidderSettings),s.window.pbjs.setConfig({...e.config,schain:o([t.supplyChainStartNode]),floors:e.config.floors||{}}),e.schain.nodes.forEach((({bidder:e,node:i,appendNode:r})=>{const n=[t.supplyChainStartNode];r&&n.push(i),s.window.pbjs.setBidderConfig({bidders:[e],config:{schain:o(n)}},!0)})),s.window.pbjs.registerSignalSources&&"function"==typeof s.window.pbjs.registerSignalSources&&s.window.pbjs.registerSignalSources(),i()}))),i)))},extractPrebidAdSlotConfigs=e=>Array.isArray(e)?e:[e],prebidPrepareRequestAds=e=>mkPrepareRequestAdsStep("prebid-prepare-adunits",LOW_PRIORITY,((t,i)=>new Promise((o=>{if(e.ephemeralAdUnits)o();else{const s=createdAdUnits(t,e,i);s.forEach((e=>{t.logger.debug("Prebid",t.requestId,`Prebid add ad unit: [Code] ${e.code}`,e)})),t.window.pbjs.addAdUnits(s),o()}})))),prebidRequestBids=(e,t)=>mkRequestBidsStep("prebid-request-bids",((i,o)=>{const s=Math.max((e.config.bidderTimeout??2e3)+3e3,e.failsafeTimeout??0),r=new Promise((e=>i.window.setTimeout(e,s))),n=new Promise((s=>{const r=o.filter((e=>!i.auction.isSlotThrottled(e.moliSlot.domId))),n=e.ephemeralAdUnits?{adUnits:createdAdUnits(i,e,r)}:{adUnitCodes:r.filter(isPrebidSlotDefinition).map((e=>e.moliSlot.domId))},a=n.adUnitCodes||n.adUnits?.map((e=>e.code)).filter(isNotNull).filter(uniquePrimitiveFilter)||[];if(0===a.length)return i.logger.debug("Prebid","skip request bids. All slots were filtered.",r.map((e=>e.moliSlot))),s();let d=!1;i.logger.debug("Prebid",`Prebid request bids: \n\t\t\t${a.join("\n\t\t\t")}`);i.window.pbjs.requestBids({...n,timeout:i.bucket?.timeout,bidsBackHandler:(e,r,n)=>{i.logger.info("Prebid",n,e,o.map((e=>e.moliSlot.domId)));try{if(d)return void i.logger.warn("Prebid",`ad server request already sent [${i.requestId}]. AuctionId ${n}`);if(!e)return i.logger.warn("Prebid",`Undefined bid response map for ad unit codes: ${a.join(", ")}`),s();d=!0,"gam"===t&&i.window.pbjs.setTargetingForGPTAsync(a),s()}catch(e){i.logger.error("Prebid","DfpService:: could not resolve bidsBackHandler"+JSON.stringify(e)),s()}}})}));return Promise.race([r,n])})),prebidDefineSlots=()=>(e,t)=>{const i=t.map((t=>{const i=new SizeConfigService(t.sizeConfig,e.labelConfigService.getSupportedLabels(),e.window),o=i.filterSupportedSizes;if(!i.filterSlot(t)||!e.labelConfigService.filterSlot(t))return Promise.resolve(null);const s={getAdUnitPath:()=>t.adUnitPath};switch(e.env){case"production":case"test":return Promise.resolve({moliSlot:t,adSlot:s,filterSupportedSizes:o});default:return Promise.reject(`invalid environment: ${e.runtimeConfig.environment}`)}}));return Promise.all(i).then((e=>e.filter(isNotNull)))},prebidRenderAds=()=>(e,t)=>new Promise(((i,o)=>{e.logger.debug("Prebid","start rendering");try{switch(e.env){case"test":e.logger.debug("Prebid","Rendering test slots"),createTestSlots(e,t);break;case"production":e.window.pbjs.getHighestCpmBids().filter((e=>e&&e.adId)).forEach((t=>{const i=e.window.document.getElementById(t.adUnitCode);if(i){const o=document.createElement("div");o.style.setProperty("border","0pt none");const s=document.createElement("iframe");s.scrolling="no",s.frameBorder="0",s.marginHeight="0",s.marginHeight="0",s.name=`prebid_ads_iframe_${t.adUnitCode}`,s.title="3rd party ad content",s.sandbox.add("allow-forms","allow-popups","allow-popups-to-escape-sandbox","allow-same-origin","allow-scripts","allow-top-navigation-by-user-activation"),s.setAttribute("aria-label","Advertisment"),s.style.setProperty("border","0"),s.style.setProperty("margin","0"),s.style.setProperty("overflow","hidden"),o.appendChild(s),i.appendChild(o);const r=s.contentWindow?.document;if(r){e.window.pbjs.renderAd(r,t.adId);const i="/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */button,hr,input{overflow:visible}progress,sub,sup{vertical-align:baseline}[type=checkbox],[type=radio],legend{box-sizing:border-box;padding:0}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}details,main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:ButtonText dotted 1px}fieldset{padding:.35em .75em .625em}legend{color:inherit;display:table;max-width:100%;white-space:normal}textarea{overflow:auto}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}[hidden],template{display:none}",o=r.createElement("style");o.appendChild(r.createTextNode(i)),r.head.appendChild(o)}else e.logger.error("Prebid",`No access to iframe contentWindow for ad unit${t.adUnitCode}`)}else e.logger.error("Prebid",`Could not locate ad slot with id ${t.adUnitCode}`)}))}i()}catch(e){o(e)}})),filterVideoPlayerSizes=(e,t)=>{return e?t((i=e,i&&2===i.length&&"number"==typeof i[0]&&"number"==typeof i[1]?[e]:e)).filter(SizeConfigService.isFixedSize):[];var i};var TCPurpose$1=tcfapi.responses.TCPurpose;const isA9SlotDefinition=e=>!!e.moliSlot.a9,hasRequiredConsent=e=>!e.gdprApplies||e.vendor.consents[793]&&[TCPurpose$1.STORE_INFORMATION_ON_DEVICE,TCPurpose$1.SELECT_BASIC_ADS,TCPurpose$1.CREATE_PERSONALISED_ADS_PROFILE,TCPurpose$1.SELECT_PERSONALISED_ADS,TCPurpose$1.MEASURE_AD_PERFORMANCE,TCPurpose$1.APPLY_MARKET_RESEARCH,TCPurpose$1.DEVELOP_IMPROVE_PRODUCTS].every((t=>e.purpose.consents[t])),a9Init=(e,t)=>mkInitStep("a9-init",(i=>new Promise((o=>{i.window.apstag=i.window.apstag||{_Q:[],init:function(){i.window.apstag._Q.push(["i",arguments])},fetchBids:function(){i.window.apstag._Q.push(["f",arguments])},setDisplayBids:function(){},targetingKeys:function(){},dpa:function(){i.window.apstag._Q.push(["di",arguments])},rpa:function(){i.window.apstag._Q.push(["ri",arguments])},upa:function(){i.window.apstag._Q.push(["ui",arguments])}},"test"!==i.env&&hasRequiredConsent(i.tcData)&&t.loadScript({name:"A9",loadMethod:AssetLoadMethod.TAG,assetUrl:e.scriptUrl?e.scriptUrl:"//c.amazon-adsystem.com/aax2/apstag.js"}).catch((e=>i.logger.error("failed to load apstag.js",e))),o()})))),a9Configure=(e,t)=>mkConfigureStep("a9-configure",((i,o)=>new Promise((o=>{i.window.apstag.init({pubID:e.pubID,adServer:"googletag",bidTimeout:e.timeout,gdpr:{cmpTimeout:e.cmpTimeout},schain:{complete:1,ver:"1.0",nodes:[t.supplyChainStartNode,e.schainNode]}}),o()})))),a9PublisherAudiences=e=>mkConfigureStepOnce("a9-publisher-audiences",((t,i)=>new Promise((i=>{const o=e.publisherAudience;if(o&&o.enabled){const e={hashedRecords:[{type:"email",record:o.sha256Email}]};if(t.logger.debug("A9","Enable publisher audiences"),t.window.apstag.rpa(e),t.window.__tcfapi){let i=!0;t.window.__tcfapi("addEventListener",2,(o=>{i?i=!1:o.eventStatus===tcfapi.status.EventStatus.USER_ACTION_COMPLETE&&(t.logger.debug("A9","Update publisher audience token"),t.window.apstag.upa(e))}))}}i()})))),a9ClearTargetingStep=()=>mkPrepareRequestAdsStep("a9-clear-targeting",LOW_PRIORITY,((e,t)=>0===e.requestId?(e.logger.debug("A9","skip ad slot clearing for first pipeline run"),Promise.resolve()):new Promise((i=>{e.logger.debug("A9","clear a9 targetings"),t.forEach((({adSlot:e})=>{e.getTargetingKeys().filter((e=>"amznp"===e||"amznsz"===e||"amznbid"===e)).forEach((t=>e.clearTargeting(t)))})),i()})))),resolveAdUnitPath=(e,t,i)=>{const o=removeChildId(e),s=t?withDepth(o,t):o;return resolveAdUnitPath$1(s,i)},a9RequestBids=e=>mkRequestBidsStep("a9-fetch-bids",((t,i)=>new Promise((o=>{if(!hasRequiredConsent(t.tcData))return t.logger.debug("A9","Skip any due to missing consent"),void o();const s=i.filter(isA9SlotDefinition).filter((e=>!t.auction.isSlotThrottled(e.moliSlot.domId))).filter((e=>{const i="video"===e.moliSlot.a9.mediaType,o=t.labelConfigService.filterSlot(e.moliSlot.a9),s=e.filterSupportedSizes(e.moliSlot.sizes).filter(SizeConfigService.isFixedSize).length>0;return o&&(i||s)})).map((({moliSlot:i,priceRule:o,filterSupportedSizes:s})=>{if("video"===i.a9.mediaType)return{slotID:i.domId,mediaType:"video"};{const r=e.supportedSizes?i.sizes.filter((t=>e.supportedSizes?.some((e=>isSizeEqual(e,t))))):i.sizes,n=resolveAdUnitPath(i.adUnitPath,i.a9.slotNamePathDepth??e.slotNamePathDepth,t.adUnitPathVariables);return{slotID:i.domId,slotName:n,sizes:s(r).filter(SizeConfigService.isFixedSize),...e.enableFloorPrices&&o?{floor:{value:Math.ceil(t.window.pbjs?.convertCurrency?100*t.window.pbjs.convertCurrency(o.floorprice,"EUR",e.floorPriceCurrency||"USD"):100*o.floorprice*1.19),currency:e.floorPriceCurrency||"USD"}}:{}}}}));t.logger.debug("A9",`Fetch '${s.length}' A9 slots: ${s.map((e=>`[slotID] ${e.slotID}`))}`),0===s.length?o():t.window.apstag.fetchBids({slots:s,...t.bucket?.timeout&&{bidTimeout:t.bucket.timeout}},(e=>{t.window.apstag.setDisplayBids(),o()}))})))),passbackPrepareRequestAds=e=>mkPrepareRequestAdsStep("passback-prepare-slots",LOW_PRIORITY,((t,i)=>new Promise((o=>{i.filter((e=>e.moliSlot.passbackSupport)).forEach((i=>{t.logger.debug("passback","add passback support for slot",i.moliSlot.domId),e.addAdSlot(i)})),o()}))));class PassbackService{constructor(e,t){this.logger=e,this.window=t,this.isInitialized=!1,this.adSlots={},this.passbackKeyValue="passback",this.passbackOriginKeyValue="passbackOrigin",this.findAdSlot=e=>e.adUnitPath?this.adSlots[e.adUnitPath]:e.domId?this.adSlots[e.domId]:void 0}addAdSlot(e){this.isInitialized||(this.isInitialized=!0,this.initMessageListener()),this.adSlots[e.moliSlot.domId]=e,this.adSlots[e.moliSlot.adUnitPath]=e}initMessageListener(){this.logger.debug("Passback Service","Add message listener"),this.window.addEventListener("message",(e=>{const t=this.parseMessageData(e.data);if(!t)return;this.logger.debug("Passback Service","Received passback message",t);const i=this.findAdSlot(t);i&&(this.logger.debug("Passback Service","Process passback for ad slot"),i.adSlot.setTargeting(this.passbackKeyValue,"true"),i.adSlot.setTargeting(this.passbackOriginKeyValue,t.passbackOrigin),this.window.googletag.pubads().refresh([i.adSlot]),delete this.adSlots[i.moliSlot.domId],delete this.adSlots[i.moliSlot.adUnitPath])}))}parseMessageData(e){if("string"==typeof e)try{const t=JSON.parse(e);return"passback"===t.type&&t.passbackOrigin&&(t.domId||t.adUnitPath)?t:null}catch(e){return null}return null}}const executeDebugDelay=(e,t)=>t?new Promise((i=>e.setTimeout(i,t))):Promise.resolve(),getDebugDelayFromLocalStorage=e=>Number(getBrowserStorageValue(BrowserStorageKeys.debugDelay,e.localStorage))||void 0;class BiddersDisabling{constructor(e,t){this.config=e,this.window=t,this.participationInfo=new Map,this.logger?.info("Bidders disabling feature is "+(e.enabled?"enabled":"disabled"))}isBidderDisabled(e,t){return this.participationInfo.get(e)?.get(t)?.disabled??!1}onAuctionEnd(e){e.bidderRequests.forEach((e=>{e.bids.forEach((e=>{const t=e.bidder,i=e.adUnitCode;this.participationInfo.get(i)||this.participationInfo.set(i,new Map);const o=this.participationInfo.get(i)?.get(t);if(o){const e=o.bidRequestCount+1;this.participationInfo.get(i)?.set(t,{...o,bidRequestCount:e})}else this.participationInfo.get(i)?.set(t,{disabled:!1,bidRequestCount:1,bidReceivedCount:0})}))})),e.bidsReceived.forEach((e=>{const t=e.bidderCode,i=e.adUnitCode,o=this.participationInfo.get(i)?.get(t);o?this.participationInfo.get(i)?.set(t,{...o,bidReceivedCount:o.bidReceivedCount+1}):this.participationInfo.get(i)?.set(t,{disabled:!1,bidRequestCount:1,bidReceivedCount:1})})),this.deactivateBidderForTTL()}deactivateBidderForTTL(){this.participationInfo.forEach(((e,t)=>{e.forEach(((e,i)=>{this.shouldDisableBidder(e)&&(this.disableBidder(t,i),this.window.setTimeout((()=>{this.enableBidder(t,i)}),this.config.reactivationPeriod))}))}))}shouldDisableBidder(e){return e.bidRequestCount>this.config.minBidRequests&&e.bidReceivedCount/e.bidRequestCount<this.config.minRate&&!e.disabled}disableBidder(e,t){const i=this.participationInfo.get(e)?.get(t);i&&(i.disabled=!0,this.logger?.info(`Bidder ${t} for position ${e} is now disabled.`))}enableBidder(e,t){const i=this.participationInfo.get(e)?.get(t);i&&(i.disabled=!1,this.logger?.info(`Bidder ${t} for position ${e} is now enabled.`))}}class AdRequestThrottling{constructor(e,t){this.config=e,this._window=t,this.slotsRequested=new Set}onSlotRequested(e){this.slotsRequested.add(e.slot.getSlotElementId()),this._window.setTimeout((()=>{this.slotsRequested.delete(e.slot.getSlotElementId())}),1e3*this.config.throttle)}isThrottled(e){return this.slotsRequested.has(e)}}class GlobalAuctionContext{constructor(e,t={}){this.window=e,this.config=t,t.biddersDisabling?.enabled&&(this.biddersDisabling=new BiddersDisabling(t.biddersDisabling,this.window)),t.adRequestThrottling?.enabled&&(this.adRequestThrottling=new AdRequestThrottling(t.adRequestThrottling,this.window)),this.window.pbjs=this.window.pbjs||{que:[]},this.window.googletag=this.window.googletag||{cmd:[]},this.config.biddersDisabling?.enabled&&this.window.pbjs.que.push((()=>{this.window.pbjs.onEvent("auctionEnd",(e=>{this.handleAuctionEndEvent(e)}))})),this.config.adRequestThrottling?.enabled&&this.window.googletag.cmd.push((()=>{this.window.googletag.pubads().addEventListener("slotRequested",(e=>{this.adRequestThrottling?.onSlotRequested(e)}))}))}isSlotThrottled(e){return this.adRequestThrottling?.isThrottled(e)??!1}handleAuctionEndEvent(e){this.biddersDisabling?.onAuctionEnd(e)}}class AdService{static getEnvironment(e){return e.environment||"production"}constructor(e,t,i){this.assetService=e,this.window=t,this.adPipelineConfig=i,this.requestAdsCalls=0,this.adPipeline=new AdPipeline({init:[()=>Promise.reject("AdPipeline not initialized yet")],configure:[],defineSlots:()=>Promise.resolve([]),prepareRequestAds:[],requestBids:[],requestAds:()=>Promise.resolve()},getDefaultLogger(),this.window,new GlobalAuctionContext(this.window)),this.initialize=(e,t)=>{const i=AdService.getEnvironment(t),o=e.adServer||"gam",s="gam"===o,r=!0===e.spa?.enabled;this.logger.setLogger(getLogger(t,this.window)),this.logger.debug("AdService",`Initializing with environment ${i} and ad server ${o}`);const n=s?[gptInit(this.assetService)]:[],a=s?[gptConfigure()]:[];s&&r&&a.push(gptDestroyAdSlots(),gptResetTargeting());const d=[];s&&d.push(gptLDeviceLabelKeyValue(),gptConsentKeyValue(),passbackPrepareRequestAds(new PassbackService(this.logger,this.window)));const l=[];if(e.prebid&&"production"===i&&(n.push(prebidInit()),a.push(prebidConfigure(e.prebid,e.schain)),r&&a.push(prebidRemoveAdUnits(e.prebid)),d.push(prebidPrepareRequestAds(e.prebid)),l.push(prebidRequestBids(e.prebid,o))),e.a9&&"production"===i&&s&&(n.push(a9Init(e.a9,this.assetService)),a.push(a9Configure(e.a9,e.schain)),a.push(a9PublisherAudiences(e.a9)),d.push(a9ClearTargetingStep()),l.push(a9RequestBids(e.a9))),"test"===i){const e=getDebugDelayFromLocalStorage(this.window);e&&a.push((()=>executeDebugDelay(this.window,e)))}return this.adPipeline=new AdPipeline({init:n,configure:a,defineSlots:s?gptDefineSlots():prebidDefineSlots(),prepareRequestAds:d,requestBids:l,requestAds:s?gptRequestAds():prebidRenderAds()},this.logger,this.window,new GlobalAuctionContext(this.window,e.globalAuctionContext)),new Promise((t=>{domready(this.window,(()=>{this.logger.debug("DOM","dom ready"),t(e)}))}))},this.requestAds=async(e,t)=>{this.requestAdsCalls=this.requestAdsCalls+1;const{refreshSlots:i,refreshInfiniteSlots:o}=t;this.logger.info("AdService",`RequestAds[${this.requestAdsCalls}]`,i);try{const s=e.slots.map((e=>this.isManualSlot(e)?i.some((t=>t===e.domId))?e:null:this.isInfiniteSlot(e)?o.some((t=>t.artificialDomId===e.domId))?e:null:this.isBackfillSlot(e)?null:e)).filter(isNotNull).filter(this.isSlotAvailable);if(e.buckets?.enabled){const i=new Map;s.forEach((e=>{const t=e.behaviour.bucket||"default",o=i.get(t);o?o.push(e):i.set(t,[e])}));return flatten(await Promise.all(Array.from(i.entries()).map((([i,o])=>(this.logger.debug("AdPipeline",`running bucket ${i}, slots:`,o),this.adPipeline.run(o,e,t,this.requestAdsCalls).then((()=>o)))))))}return await this.adPipeline.run(s,e,t,this.requestAdsCalls),s}catch(e){return this.logger.error("AdPipeline","slot filtering failed",e),Promise.reject(e)}},this.getAdPipeline=()=>this.adPipeline,this.setLogger=e=>{this.logger.setLogger(e)},this.isManualSlot=e=>"manual"===e.behaviour.loaded,this.isInfiniteSlot=e=>"infinite"===e.behaviour.loaded,this.isBackfillSlot=e=>"backfill"===e.behaviour.loaded,this.isSlotAvailable=e=>!!this.window.document.getElementById(e.domId)||"out-of-page-interstitial"===e.position||"out-of-page-top-anchor"===e.position||"out-of-page-bottom-anchor"===e.position,this.logger=new ProxyLogger(getDefaultLogger()),i&&(this.adPipeline=new AdPipeline(i,this.logger,t,new GlobalAuctionContext(t)))}refreshAdSlots(e,t,i,o){if(0===e.length)return Promise.resolve();const{loaded:s}={loaded:"manual",...o},r=t.slots.filter((t=>e.some((e=>e===t.domId))&&(t.behaviour.loaded===s||"infinite"===t.behaviour.loaded))).filter(this.isSlotAvailable).map((e=>o?.sizesOverride?{...e,sizes:o.sizesOverride}:e));if(e.length!==r.length){const t=r.filter((t=>e.every((e=>e!==t.domId)))),i=e.filter((e=>r.every((t=>t.domId!==e))));t.length&&this.logger.warn("AdService","The following slots do not exist on the page DOM.",t),i.length&&this.logger.warn("AdService","The following slots are not configured in the ad-tag config.",t)}return this.logger.debug("AdService","refresh ad slots",r),this.adPipeline.run(r,t,i,this.requestAdsCalls)}refreshBucket(e,t,i){if(!t.buckets?.enabled)return Promise.resolve();const o=t.slots.filter(this.isManualSlot).filter((t=>t.behaviour.bucket===e));return this.logger.debug("AdService","refresh ad buckets",o,t.targeting),this.adPipeline.run(o,t,i,this.requestAdsCalls,e)}}const QueryParameters={moliEnv:"moliEnv",moliPubCode:"moliPubCode",moliVersion:"moliVersion"},resolveOverrides=(e,t,i,o=(e=>!0))=>[{source:"queryParam",value:parseQueryString(e.location.search).get(t)},{source:"sessionStorage",value:getBrowserStorageValue(i,e.sessionStorage)},{source:"localStorage",value:getBrowserStorageValue(i,e.localStorage)}].map((({source:e,value:t})=>t&&o(t)?{source:e,value:t}:void 0)).filter(isNotNull),isEnvironmentString=e=>!!["production","test"].find((t=>t===e)),getActiveEnvironmentOverride=e=>resolveOverrides(e,QueryParameters.moliEnv,BrowserStorageKeys.moliEnv,isEnvironmentString)[0]||void 0,setEnvironmentOverrideInStorage=(e,t)=>setBrowserStorageValue(BrowserStorageKeys.moliEnv,e,t),packageJson={version:"5.0.0-alpha.14"},allowRefreshAdSlot=(e,t,i)=>{switch(e){case"none":return!0;case"href":return i.href===t;case"path":try{const e=new URL(t);return i.pathname===e.pathname}catch(e){return!0}}},allowRequestAds=(e,t,i)=>{switch(e){case"none":return!0;case"href":return i.href!==t;case"path":try{const e=new URL(t);return i.pathname!==e.pathname}catch(e){return!0}}},createMoliTag=e=>{const t=createAssetLoaderService(e),i=new AdService(t,e),o=e;let s={state:"configurable",initialize:!1,runtimeConfig:c(),modules:[]};function r(t,i){switch(s.state){case"configurable":case"configured":s.runtimeConfig.keyValues[t]=i;break;case"spa-finished":case"spa-requestAds":s.nextRuntimeConfig.keyValues[t]=i;break;default:getLogger(s.runtimeConfig,e).error("MoliGlobal",`Setting key-value after configuration: ${t} : ${i}`)}}function n(t){switch(s.state){case"configurable":case"configured":s.runtimeConfig.labels.push(t);break;case"spa-requestAds":case"spa-finished":s.nextRuntimeConfig.labels.push(t);break;default:getLogger(s.runtimeConfig,e).error("MoliGlobal",`Adding label after configure: ${t}`)}}function a(){return{keyValues:{...s.config?.targeting?.keyValues,...s.runtimeConfig.keyValues},labels:[...s.config?.targeting?.labels??[],...s.runtimeConfig.labels],adUnitPathVariables:{...s.config?.targeting?.adUnitPathVariables,...s.runtimeConfig.adUnitPathVariables}}}function d(){switch(s.state){case"configurable":return s.initialize=!0,Promise.resolve(s);case"configured":{l(),u(s.config.domain);const{refreshInfiniteSlots:t}=s.runtimeConfig;let o=s.config;t.length>0&&t.forEach((t=>{o=addNewInfiniteSlotToConfig(o,t.idOfConfiguredSlot,t.artificialDomId,getLogger(s.runtimeConfig,e))}));const r=s.modules,n=getLogger(s.runtimeConfig,e);n.debug("MoliGlobal","configure modules",o.modules??{}),r.forEach((e=>{try{e.configure(o.modules??{}),n.debug("MoliGlobal",`configure ${e.moduleType} module ${e.name}`,e.config())}catch(t){n.error("MoliGlobal",`failed to configure ${e.moduleType} module ${e.name}`,t)}})),s.runtimeConfig.hooks&&s.runtimeConfig.hooks.beforeRequestAds&&s.runtimeConfig.hooks.beforeRequestAds.forEach((e=>{try{e(o,s.runtimeConfig)}catch(e){n.error("MoliGlobal","beforeRequestAds hook failed",e)}}));const a=s.runtimeConfig.hooks.afterRequestAds;if(!0===o.spa?.enabled){const t=s.runtimeConfig,n=i.initialize(o,t);return s={state:"spa-requestAds",config:o,initialized:n,modules:r,href:e.location.href,runtimeConfig:Object.freeze(c(s.runtimeConfig,{keepTargeting:!0})),nextRuntimeConfig:c(s.runtimeConfig)},n.then((()=>i.requestAds(o,t))).then((()=>{if("spa-requestAds"===s.state&&s.href===e.location.href){i.refreshAdSlots(s.runtimeConfig.refreshSlots,s.config,s.runtimeConfig),a.forEach((e=>e("spa-finished")));const e={...s,state:"spa-finished",nextRuntimeConfig:c(s.runtimeConfig),runtimeConfig:c(s.runtimeConfig,{keepTargeting:!0})};return s=e,e}return"spa-finished"===s.state||"spa-requestAds"===s.state?(getLogger(s.runtimeConfig,e).debug("MoliGlobal","A previous requestAds() was slower than the following requestAds() call"),s):Promise.reject(`reached invalid state [${s.state}]`)}))}return s={state:"requestAds",config:o,modules:r,runtimeConfig:Object.freeze(s.runtimeConfig)},i.initialize(o,s.runtimeConfig).then((e=>i.requestAds(e,s.runtimeConfig))).then((()=>(s={state:"finished",config:o,runtimeConfig:s.runtimeConfig,modules:r},a.forEach((e=>e("finished"))),Promise.resolve(s)))).catch((t=>(getLogger(s.runtimeConfig,e).error("MoliGlobal",t),s={state:"error",config:o,runtimeConfig:s.runtimeConfig,error:t,modules:r},a.forEach((e=>e("error"))),Promise.resolve(s))))}case"spa-requestAds":case"spa-finished":{"spa-requestAds"===s.state&&getLogger(s.runtimeConfig,e).debug("MoliGlobal","requestAds is being called while the previous requestAds() hasn't finished yet"),l(),u(s.config.domain);const{modules:t}=s,o=s.nextRuntimeConfig.hooks.afterRequestAds,r=s.nextRuntimeConfig.hooks.beforeRequestAds,n=s,{initialized:a,href:d,nextRuntimeConfig:g}=s;return s={...n,state:"spa-requestAds",runtimeConfig:c(s.nextRuntimeConfig,{keepTargeting:!0}),nextRuntimeConfig:c(s.runtimeConfig)},a.then((t=>{const o=t.spa?.validateLocation??"href";return allowRequestAds(o,d,e.location)?(r.forEach((i=>{try{i(t,s.runtimeConfig)}catch(t){getLogger(s.runtimeConfig,e).error("MoliGlobal","beforeRequestAds hook failed",t)}})),i.requestAds(t,g).then((()=>t))):Promise.reject(`You are trying to refresh ads on the same page, which is not allowed. Using ${o} for validation.`)})).then((r=>(i.refreshAdSlots(s.runtimeConfig.refreshSlots,r,s.runtimeConfig),s={state:"spa-finished",config:r,initialized:a,modules:t,href:e.location.href,runtimeConfig:s.runtimeConfig,nextRuntimeConfig:c(s.runtimeConfig)},o.forEach((e=>e("spa-finished"))),s)))}case"requestAds":return getLogger(s.runtimeConfig,e).error("MoliGlobal","Trying to requestAds twice. Already requesting ads."),Promise.reject();case"finished":return getLogger(s.runtimeConfig,e).error("MoliGlobal","Trying to requestAds twice. Already finished."),Promise.reject();case"error":return getLogger(s.runtimeConfig,e).error("MoliGlobal","Trying to requestAds twice. Already finished, but with an error.",s.error),Promise.reject()}}function l(){const t="ABtest",i=parseQueryString(e.location.search).get(t);r(t,(i?Number(i):Math.floor(100*Math.random())+1).toString())}function u(t){const i=t||extractTopPrivateDomainFromHostname(e.location.hostname);i&&n(i)}function c(e,t){return{environment:e?.environment??"production",hooks:{beforeRequestAds:e?.hooks.beforeRequestAds??[],afterRequestAds:e?.hooks.afterRequestAds??[]},logger:e?.logger??void 0,adUnitPathVariables:!0===t?.keepTargeting?e?.adUnitPathVariables??{}:{},labels:!0===t?.keepTargeting?e?.labels??[]:[],keyValues:!0===t?.keepTargeting?e?.keyValues??{}:{},refreshSlots:[],refreshInfiniteSlots:[],adPipelineConfig:{initSteps:[],configureSteps:[],prepareRequestAdsSteps:[]}}}return{que:{push(e){e(o.moli)}},version:packageJson.version,setTargeting:r,addLabel:n,setLogger:function(e){switch(s.state){case"configurable":case"configured":s.runtimeConfig.logger=e;break;default:e.error("Setting a custom logger is not allowed after configuration")}},setAdUnitPathVariables:function(t){switch(s.state){case"configurable":case"configured":s.runtimeConfig.adUnitPathVariables=t;break;case"spa-requestAds":case"spa-finished":s.nextRuntimeConfig.adUnitPathVariables=t;break;default:getLogger(s.runtimeConfig,e).error("MoliGlobal",`Setting unit path variables after configuration: ${t}`)}},resolveAdUnitPath:function(t,i){const o=(i||{}).removeNetworkChildId||!1,r=resolveAdUnitPath$1(t,function(){const t=extractTopPrivateDomainFromHostname(e.location.hostname)||"unknown";switch(s.state){case"configurable":return{...s.runtimeConfig.adUnitPathVariables,domain:t,device:"unknown"};case"configured":case"requestAds":case"spa-requestAds":case"spa-finished":case"finished":case"error":const i=new LabelConfigService(s.config.labelSizeConfig||[],[],e);return{...a().adUnitPathVariables,domain:s.config.domain||t,device:i.getDeviceLabel()}}}());return o?removeChildId(r):r},beforeRequestAds:function(t){switch(s.state){case"configurable":case"configured":s.runtimeConfig.hooks.beforeRequestAds.push(t);break;default:getLogger(s.runtimeConfig,e).error("MoliGlobal","Trying to add a hook beforeRequestAds. Already configured.",s.config)}},afterRequestAds:function(t){switch(s.state){case"configurable":case"configured":s.runtimeConfig.hooks.afterRequestAds.push(t);break;default:getLogger(s.runtimeConfig,e).error("MoliGlobal","Trying to add a hook afterRequestAds. Already configured.",s.config)}},getConfig:function(){switch(s.state){case"configurable":return null;case"configured":case"requestAds":case"spa-requestAds":case"spa-finished":case"finished":case"error":return s.config}},getRuntimeConfig:function(){return s.runtimeConfig},getPageTargeting:a,registerModule:function(i){switch(s.state){case"configurable":case"configured":return s.modules.push(i),s.runtimeConfig.adPipelineConfig.initSteps.push(...i.initSteps(t)),s.runtimeConfig.adPipelineConfig.configureSteps.push(...i.configureSteps()),void s.runtimeConfig.adPipelineConfig.prepareRequestAdsSteps.push(...i.prepareRequestAdsSteps());default:getLogger(s.runtimeConfig,e).error("Registering a module is only allowed within the ad tag before the ad tag is configured")}},configure:function(t){switch(s.state){case"configurable":{const i=s.initialize,o=getActiveEnvironmentOverride(e),r=s.modules;o&&(s.runtimeConfig.environment=o.value),"queryParam"===o?.source&&setEnvironmentOverrideInStorage(o.value,e.sessionStorage),s={state:"configured",config:t,runtimeConfig:s.runtimeConfig,modules:r},i&&d();break}case"configured":getLogger(s.runtimeConfig,e).error("MoliGlobal","Trying to configure moli tag twice. Already configured.",s.config);break;case"requestAds":getLogger(s.runtimeConfig,e).error("MoliGlobal","Trying to configure moli tag twice. Already requesting ads.");break;case"finished":getLogger(s.runtimeConfig,e).error("MoliGlobal","Trying to configure moli tag twice. Already finished.");break;case"error":getLogger(s.runtimeConfig,e).error("MoliGlobal","Trying to configure moli tag twice. Already finished, but with an error.",s.error)}},requestAds:d,refreshAdSlot:function(t,o){const r="string"==typeof t?[t]:t;switch(s.state){case"configurable":case"configured":case"spa-requestAds":return s.runtimeConfig.refreshSlots.push(...r),Promise.resolve("queued");case"spa-finished":const t=s.config.spa?.validateLocation??"href";return allowRefreshAdSlot(t,s.href,e.location)?i.refreshAdSlots(r,s.config,s.runtimeConfig,o).then((()=>"refreshed")):(s.nextRuntimeConfig.refreshSlots.push(...r),Promise.resolve("queued"));case"finished":case"requestAds":return i.refreshAdSlots(r,s.config,s.runtimeConfig,o).then((()=>"refreshed"));default:return getLogger(s.runtimeConfig,e).error("MoliGlobal",`refreshAdSlot is not allowed in state ${s.state}`,s.config),Promise.reject(`not allowed in state ${s.state}`)}},refreshBucket:function(t){function r(e){const i=e.slots.filter((e=>e.behaviour.bucket===t));return i?.map((e=>e.domId))}switch(s.state){case"configurable":{const e=o.moli.getConfig()?.slots.filter((e=>e.behaviour.bucket===t)),i=e?.map((e=>e.domId));return i?.length?(s.runtimeConfig.refreshSlots.push(...i),Promise.resolve("queued")):Promise.reject("no configurable domIds for buckets")}case"configured":{const e=r(s.config);return s.runtimeConfig.refreshSlots.push(...e),Promise.resolve("queued")}case"spa-requestAds":{const e=r(s.config);return s.runtimeConfig.refreshSlots.push(...e),Promise.resolve("queued")}case"spa-finished":if(s.href===e.location.href)return i.refreshBucket(t,s.config,s.runtimeConfig).then((()=>"refreshed"));{const e=r(s.config);return s.runtimeConfig.refreshSlots.push(...e),Promise.resolve("queued")}case"finished":case"requestAds":return i.refreshBucket(t,s.config,s.runtimeConfig).then((()=>"refreshed"));default:return getLogger(s.runtimeConfig,e).error("MoliGlobal",`refreshAdSlot is not allowed in state ${s.state}`,s.config),Promise.reject(`not allowed in state ${s.state}`)}},refreshInfiniteAdSlot:function(t,o){switch(s.state){case"configurable":case"configured":case"spa-requestAds":return s.runtimeConfig.refreshInfiniteSlots.push({artificialDomId:t,idOfConfiguredSlot:o}),Promise.resolve("queued");case"spa-finished":return s.href===e.location.href?(s={...s,config:addNewInfiniteSlotToConfig(s.config,o,t,getLogger(s.runtimeConfig,e))},i.refreshAdSlots([t],s.config,s.runtimeConfig).then((()=>"refreshed"))):(s.runtimeConfig.refreshInfiniteSlots.push({artificialDomId:t,idOfConfiguredSlot:o}),Promise.resolve("queued"));case"finished":case"requestAds":return s={...s,config:addNewInfiniteSlotToConfig(s.config,o,t,getLogger(s.runtimeConfig,e))},i.refreshAdSlots([t],s.config,s.runtimeConfig).then((()=>"refreshed"));default:return getLogger(s.runtimeConfig,e).error("MoliGlobal",`refreshInfiniteAdSlot is not allowed in state ${s.state}`,s.config),Promise.reject(`not allowed in state ${s.state}`)}},getModuleMeta:function(){return s.modules},getState:function(){return s.state},openConsole:function(e){if("configurable"===s.state);else t.loadScript({assetUrl:e??`https://highfivve.github.io/moli-ad-tag/assets/bundle/v${packageJson.version}/console.js`,loadMethod:AssetLoadMethod.TAG,name:"moli-debugger"}).catch((e=>console.error("failed to load moli debugger",e)))},getAssetLoaderService:function(){return t}}},initAdTag=e=>{const t=e,i=t.moli&&[...t.moli.que]||[],o=createMoliTag(e);return t.moli=o,i.forEach((e=>e(o))),o};initAdTag(window);const toAdexMapType=(e,t,i)=>{const o=e[t.key],s=extractStringOrNumber(e,t.valueType,t.valueKey);if(!o||Array.isArray(o)||void 0===s&&void 0===t.defaultValue||"number"===t.valueType&&Number.isNaN(s)&&void 0===t.defaultValue)return void i.warn("Adex DMP",`values for key ${t.key}/valueKey ${t.valueKey} were empty or key was an array. Key/Value:`,o,s);const r=convertToAdexTargetValue(s,t,i);return{[t.attribute]:{[o]:r}}},toAdexStringOrNumberType=(e,t,i)=>{const o=extractStringOrNumber(e,t.adexValueType,t.key);if(void 0===o&&void 0===t.defaultValue||"number"===t.adexValueType&&(Number.isNaN(o)&&void 0===t.defaultValue||Array.isArray(o)))return void i.warn("Adex DMP",`value for key ${t.key} was empty or key was an array. Value:`,o);const s=convertToAdexTargetValue(o,t,i);return{[t.attribute]:s}},toAdexListType=(e,t,i)=>{const o=extractStringOrNumber(e,"string",t.key);if(void 0===o&&(void 0===t.defaultValue||0===t.defaultValue.length)||"number"==typeof o)return void i.warn("Adex DMP",`value for key "${t.key}" was empty or number. Value:`,o);const s=convertToAdexListValue(o,t,i);return{[t.attribute]:s}},sortAndToListObject=e=>Object.fromEntries(e.sort().map((e=>[e,1]))),sortAndJoin=e=>e.sort().join(","),extractStringOrNumber=(e,t,i)=>"number"===t?Number(e[i]):e[i],convertToAdexTargetValue=(e,t,i)=>void 0===e||Number.isNaN(e)?logAndUseDefaultValue(t,i):Array.isArray(e)?sortAndJoin(e):e,convertToAdexListValue=(e,t,i)=>void 0===e?logAndUseDefaultValue(t,i):Array.isArray(e)?sortAndToListObject(e):{[e]:1},logAndUseDefaultValue=(e,t)=>(t.warn("Adex DMP","using defaultValue",e.defaultValue,"as fallback for key",e.key),"list"===e.adexValueType?e.defaultValue?sortAndToListObject(e.defaultValue):void 0:e.defaultValue),getAdvertisingIdIFAType=e=>"android"===e?"aaid":"ios"===e?"idfa":void 0,sendAdvertisingID=(e,t,i,o,s,r,n,a)=>{const d=getAdvertisingIdIFAType("string"==typeof s?s:s[0]),l=o.reduce(((e,t)=>({...e,...t})),{});r(`https://api.theadex.com/collector/v1/ifa/c/${e}/t/${t}/request?&ifa=${i}&ifa_type=${d}${o.length?`&kv=${JSON.stringify(l)}`:""}${a?`&gdpr_consent=${a}`:""}`).catch((e=>n.error(e)))};var TCPurpose=tcfapi.responses.TCPurpose;class AdexModule{constructor(){this.name="the-adex-dmp",this.description="Moli DMP module for The Adex.",this.moduleType="dmp",this.adexConfig=null,this.window={_adexc:[["/","ut","_kv",[{},0]]]},this.isLoaded=!1,this.hasRequiredConsent=e=>!e.gdprApplies||e.vendor.consents[44]&&[TCPurpose.STORE_INFORMATION_ON_DEVICE,TCPurpose.SELECT_BASIC_ADS,TCPurpose.CREATE_PERSONALISED_ADS_PROFILE,TCPurpose.SELECT_PERSONALISED_ADS,TCPurpose.CREATE_PERSONALISED_CONTENT_PROFILE,TCPurpose.SELECT_PERSONALISED_CONTENT,TCPurpose.MEASURE_AD_PERFORMANCE,TCPurpose.MEASURE_CONTENT_PERFORMANCE,TCPurpose.APPLY_MARKET_RESEARCH,TCPurpose.DEVELOP_IMPROVE_PRODUCTS].every((t=>e.purpose.consents[t])),this.getAdexKeyValues=(e,t)=>{const i=e.config.targeting?.keyValues;if(i)return t.mappingDefinitions.map((t=>{switch(t.adexValueType){case"map":return toAdexMapType(i,t,e.logger);case"list":return toAdexListType(i,t,e.logger);default:return toAdexStringOrNumberType(i,t,e.logger)}})).filter(isNotNull)},this.configureAdexC=(e,t)=>{if(!e.config.targeting)return e.logger.warn("Adex DMP","targeting key/values are empty"),Promise.resolve();{const i=this.getAdexKeyValues(e,t);i&&this.window._adexc?.push([`/${t.adexCustomerId}/${t.adexTagId}/`,"ut","_kv",[i.reduce(((e,t)=>({...e,...t})),{}),t.spaMode?1:0]])}}}config(){return this.adexConfig}configure(e){e?.adex&&e.adex.enabled&&(this.adexConfig=e.adex)}initSteps(e){const t=this.adexConfig;return t?[mkInitStep("DMP module setup",(i=>this.track(i,e,t)))]:[]}configureSteps(){const e=this.adexConfig;return e?.spaMode?[mkConfigureStep("DMP module setup",(t=>(this.configureAdexC(t,e),Promise.resolve())))]:[]}track(e,t,i){const{adexCustomerId:o,adexTagId:s,mappingDefinitions:r,spaMode:n,appConfig:a}=i;this.configureAdexC(e,i);const d=this.getAdexKeyValues(e,i),l=e.config.targeting?.keyValues;if(this.hasRequiredConsent(e.tcData)&&!this.isLoaded&&l){this.isLoaded=!0;const i=isNotNull(a)&&isNotNull(l[a.advertiserIdKey])&&("android"===l[a.clientTypeKey]||"ios"===l[a.clientTypeKey]);if(a?.advertiserIdKey&&i){const t=e.tcData.gdprApplies?e.tcData.tcString:void 0,i=l[a.advertiserIdKey];"string"==typeof i&&d&&sendAdvertisingID(o,a.adexMobileTagId?a.adexMobileTagId:s,i,d,l[a.clientTypeKey]??"",e.window.fetch,e.logger,t)}else t.loadScript({name:this.name,assetUrl:`https://dmp.theadex.com/d/${o}/${s}/s/adex.js`,loadMethod:AssetLoadMethod.TAG}).catch((t=>e.logger.error("failed to load adex",t)))}return Promise.resolve()}prepareRequestAdsSteps(){return[]}}window.moli.registerModule(new AdexModule);class AdVisibilityService{constructor(e,t,i,o,s,r,n){this.userActivityService=e,this.refreshInterval=t,this.refreshIntervalOverrides=i,this.useIntersectionObserver=o,this.disableAdVisibilityChecks=s,this.window=r,this.logger=n,this.isSlotTracked=e=>this.visibilityRecords.has(e),this.removeSlotTracking=e=>{this.logger?.debug("AdVisibilityService",`removing slot visibility tracking for ${e.getSlotElementId()}`,e),this.visibilityRecords.delete(e.getSlotElementId())},this.handleGoogletagAdVisibilityChanged=e=>{const t=e.slot,i=this.visibilityRecordForGoogletagEvent(e);i&&(this.logger?.debug("AdVisibilityService",`Visibility of slot ${t.getSlotElementId()} changed. Visible area: ${e.inViewPercentage}%`),this.updateVisibilityRecord(i,e.inViewPercentage/100))},this.updateVisibilityRecord=(e,t)=>{if(e.latestStartVisible){const t=this.window.performance.now()-e.latestStartVisible;this.logger?.debug("AdVisibilityService",`added ${Math.round(t)}ms visibility to ${e.slot.getSlotElementId()}`),e.durationVisibleSum+=t}t>=this.minimalAdVisibilityRatio?(e.latestStartVisible=this.window.performance.now(),this.logger?.debug("AdVisibilityService",`ad ${e.slot.getSlotElementId()} visible`)):(e.latestStartVisible=void 0,this.logger?.debug("AdVisibilityService",`ad ${e.slot.getSlotElementId()} not visible`))},this.visibilityRecordForGoogletagEvent=e=>this.visibilityRecords.get(e.slot.getSlotElementId()),this.minimalAdVisibilityRatio=s?0:.5,this.visibilityRecords=new Map,o&&"IntersectionObserver"in this.window&&(this.intersectionObserver=new IntersectionObserver((e=>this.handleObservedAdVisibilityChanged(e)),{threshold:this.minimalAdVisibilityRatio})),o||this.window.googletag.pubads().addEventListener("slotVisibilityChanged",this.handleGoogletagAdVisibilityChanged),this.userActivityService.addUserActivityChangedListener((e=>this.handleUserActivityChanged(e))),this.setUpdateTimer(!0),this.logger?.debug("AdVisibilityService","initialized")}trackSlot(e,t){const i=e.getSlotElementId(),o=this.window.document.getElementById(i);o&&(this.logger?.debug("AdVisibilityService",`tracking slot ${e.getSlotElementId()}`,e),this.isSlotTracked(i)&&this.removeSlotTracking(e),this.visibilityRecords.set(e.getSlotElementId(),{slot:e,latestStartVisible:this.disableAdVisibilityChecks?this.window.performance.now():void 0,durationVisibleSum:0,refreshCallback:t}),this.intersectionObserver&&this.intersectionObserver.observe(o))}setUpdateTimer(e){e?this.visibilityUpdateTimer=this.window.setInterval((()=>this.updateAdVisibilityDuration()),AdVisibilityService.updateVisibilityInterval):(this.window.clearInterval(this.visibilityUpdateTimer),this.visibilityUpdateTimer=void 0)}updateAdVisibilityDuration(){this.visibilityRecords.forEach((e=>{if(e.latestStartVisible){const t=this.window.performance.now(),i=Math.round(t-e.latestStartVisible);e.durationVisibleSum+=i,e.latestStartVisible=t,this.logger?.debug("AdVisibilityService",`added ${i}ms visibility to ${e.slot.getSlotElementId()}, now totalling at ${e.durationVisibleSum}ms`)}})),Array.from(this.visibilityRecords.values()).filter((e=>{const t=this.refreshIntervalOverrides[e.slot.getSlotElementId()]||this.refreshInterval;return e.durationVisibleSum>t})).forEach((e=>{this.logger?.debug("AdVisibilityService",`refreshing ad ${e.slot.getSlotElementId()} after ${e.durationVisibleSum}ms visibility`),e.latestStartVisible=this.window.performance.now(),e.durationVisibleSum=-AdVisibilityService.consecutiveDurationToRefresh,e.refreshCallback(e.slot)}))}handleObservedAdVisibilityChanged(e){e.forEach((e=>{const t=this.visibilityRecordForEntry(e);t&&(this.logger?.debug("AdVisibilityService",`Visibility of slot ${t.slot.getSlotElementId()} changed. Visible area: ${100*e.intersectionRatio}%`),this.updateVisibilityRecord(t,e.intersectionRatio))}))}handleUserActivityChanged(e){this.visibilityRecords.forEach((e=>{e.latestStartVisible&&(e.latestStartVisible=this.window.performance.now())})),this.setUpdateTimer(e)}visibilityRecordForEntry(e){return this.visibilityRecords.get(e.target.id)}}AdVisibilityService.updateVisibilityInterval=1e3,AdVisibilityService.consecutiveDurationToRefresh=1500;const userActivityParametersForLevel=new Map([["strict",{userActivityDuration:1e4,userBecomingInactiveDuration:5e3}],["moderate",{userActivityDuration:12e3,userBecomingInactiveDuration:8e3}],["lax",{userActivityDuration:15e3,userBecomingInactiveDuration:12e3}]]);class UserActivityService{constructor(e,t={level:"strict"},i){if(this.window=e,this.userActivityLevelControl=t,this.logger=i,this.isActive=!0,this.handleUserInteraction=()=>this.userActive(),this.handleUserIdle=()=>this.userInactive(),this.handleUserBecomingIdle=()=>this.userBecomingInactive(),this.handlePageVisibilityChanged=()=>{this.window.document.hidden?this.userInactive():this.userActive()},this.listener=[],this.window.document.addEventListener("visibilitychange",this.handlePageVisibilityChanged),this.logger?.debug("UserActivityService","initialized"),"custom"===t.level)this.userActivityDuration=t.userActivityDuration,this.userBecomingInactiveDuration=t.userBecomingInactiveDuration;else{const{userActivityDuration:e,userBecomingInactiveDuration:i}=userActivityParametersForLevel.get(t.level);this.userActivityDuration=e,this.userBecomingInactiveDuration=i}this.userActive()}addUserActivityChangedListener(e){this.listener.push(e)}userActive(){this.isActive||(this.isActive=!0,this.listener.forEach((e=>e(this.isActive))),this.logger?.debug("UserActivityService","user has become active")),UserActivityService.observedEvents.forEach((e=>this.window.removeEventListener(e,this.handleUserInteraction))),this.userInactiveTimer&&this.window.clearTimeout(this.userInactiveTimer),this.userBecomingIdleTimer&&this.window.clearTimeout(this.userBecomingIdleTimer),this.userInactiveTimer=this.window.setTimeout(this.handleUserIdle,this.userActivityDuration),this.userBecomingIdleTimer=this.window.setTimeout(this.handleUserBecomingIdle,this.userBecomingInactiveDuration)}userInactive(){this.isActive=!1,UserActivityService.observedEvents.forEach((e=>this.window.addEventListener(e,this.handleUserInteraction))),this.listener.forEach((e=>e(this.isActive))),this.logger?.debug("UserActivityService","user has become inactive")}userBecomingInactive(){UserActivityService.observedEvents.forEach((e=>this.window.addEventListener(e,this.handleUserInteraction))),this.logger?.debug("UserActivityService","user will shortly become inactive")}}UserActivityService.observedEvents=["mousemove","touchstart","scroll","keypress"];class AdReload{constructor(){this.name="moli-ad-reload",this.description="Moli implementation of an ad reload module.",this.moduleType="ad-reload",this.moduleConfig=null,this.refreshIntervalMs=2e4,this.reloadKeyValue="native-ad-reload",this.initialized=!1,this.initialize=(e,t,i,o)=>{"test"!==e.env?this.initialized||(e.logger.debug("AdReload","initialize moli ad reload module"),this.setupAdVisibilityService(t,e.window,e.logger),this.setupSlotRenderListener(t,i,o,e.window,e.logger),this.initialized=!0):e.logger.info("AdReload","disabled in environment test")},this.setupAdVisibilityService=(e,t,i)=>{this.adVisibilityService=new AdVisibilityService(new UserActivityService(t,e.userActivityLevelControl,i),this.refreshIntervalMs,e.refreshIntervalMsOverrides||{},!1,!!e.disableAdVisibilityChecks,t,i)},this.setupSlotRenderListener=(e,t,i,o,s)=>o.googletag.pubads().addEventListener("slotRenderEnded",(o=>{const{slot:r,campaignId:n,advertiserId:a,yieldGroupIds:d,isEmpty:l}=o,u=r.getSlotElementId(),c=t.indexOf(u)>-1,g=!n||-1===e.excludeOrderIds.indexOf(n),p=!!n&&e.includeOrderIds.indexOf(n)>-1,h=!!a&&e.includeAdvertiserIds.indexOf(a)>-1,f=!!d&&e.includeYieldGroupIds.some((e=>d.indexOf(e)>-1)),m=!l&&c&&g&&(p||h||f);m||this.logTrackingDisallowedReason(u,{slotIsEmpty:l,slotIsMonitored:c,orderIdNotExcluded:g,orderIdIncluded:p,advertiserIdIncluded:h,yieldGroupIdIncluded:f},s,d,n,a);const b=!!this.adVisibilityService?.isSlotTracked(u);m?this.adVisibilityService.trackSlot(r,i):b&&this.adVisibilityService.removeSlotTracking(r)})),this.reloadAdSlot=(e,t)=>i=>{const o=i.getSlotElementId(),s=t.config.slots.find((e=>e.domId===o));if(s&&"infinite"!==s.behaviour.loaded){t.logger.debug("AdReload","fired slot reload",s.domId);const r=this.maybeOptimizeSlotForCls(e,s,i,t.logger,t.window);i.setTargeting(this.reloadKeyValue,"true"),t.window.moli.refreshAdSlot(o,{loaded:s.behaviour.loaded,...r&&{sizesOverride:r}})}},this.maybeOptimizeSlotForCls=(e,t,i,o,s)=>{const r=t.domId;if(e.optimizeClsScoreDomIds.indexOf(r)>-1){const e=s.document.getElementById(r);if(e&&e.style){const n=e.scrollHeight;e.style.setProperty("height",`${n}px`);const a=t.sizes.filter((e=>"fluid"!==e&&e[1]<=n));return o.debug("AdReload",`CLS optimization: slot ${r} received fixed height ${n}px`,"new sizes:",a),a.length<t.sizes.filter((e=>"fluid"!==e)).length&&s.googletag.destroySlots([i]),a}o.warn("AdReload",`CLS optimization: slot ${r} to be optimized but not found in DOM.`)}return t.sizes},this.logTrackingDisallowedReason=(e,t,i,o,s,r)=>{const{slotIsEmpty:n,slotIsMonitored:a,orderIdNotExcluded:d,orderIdIncluded:l,advertiserIdIncluded:u,yieldGroupIdIncluded:c}=t;n&&i.debug("AdReload",e,"slot not tracked: reported empty"),a||i.debug("AdReload",e,"slot not tracked: excluded by DOM id"),d||i.debug("AdReload",e,"slot not tracked: excluded by order id",s),l||u||c||i.debug("AdReload",e,"slot not tracked: neither order id",s,"nor advertiser id",r,"nor yieldGroup id",o,"included")}}config(){return this.moduleConfig}isInitialized(){return this.initialized}configure(e){e?.adReload?.enabled&&(this.moduleConfig=e.adReload)}initSteps(){return[]}configureSteps(){const e=this.moduleConfig;return e?[mkConfigureStep(this.name,(t=>{const i=t.config.slots.filter((t=>-1===e.excludeAdSlotDomIds.indexOf(t.domId))).map((e=>e.domId)),o=this.reloadAdSlot(e,t);return t.logger.debug("AdReload","monitoring slots",i),this.initialize(t,e,i,o),Promise.resolve()}))]:[]}prepareRequestAdsSteps(){return[]}}window.moli.registerModule(new AdReload);class BlocklistedUrls{constructor(){this.name="Blocklist URLs",this.description="Blocks ad requests entirely or adds key-values for blocklistd urls",this.moduleType="policy",this.blocklistConfig=null,this.window={},this.isBlocklisted=(e,t,i)=>e.urls.some((({pattern:e,matchType:o})=>{switch(o){case"exact":return t===e;case"contains":return t.indexOf(e)>-1;case"regex":try{const o=RegExp(e).test(t);return o&&i.debug(this.name,`Url '${t}' matched pattern '${e}'`),o}catch(t){return i.error(this.name,`Invalid pattern ${e}`,t),console.log(this.name,`Invalid pattern ${e}`,t),!1}}}))}config(){return this.blocklistConfig}configure(e){e?.blocklist&&e.blocklist.enabled&&(this.blocklistConfig=e.blocklist)}initSteps(e){return this.blocklistConfig?[mkInitStep("blocklist-urls-init",(t=>{switch(this.blocklistConfig?.mode){case"key-value":const i=this.blocklistConfig.key,o=this.blocklistConfig.isBlocklistedValue||"true";return this.getBlocklist(this.blocklistConfig.blocklist,e,t.logger)().then((e=>{this.isBlocklisted(e,this.window.location.href,t.logger)&&this.window.googletag.pubads().setTargeting(i,o)}));case"block":return this.getBlocklist(this.blocklistConfig.blocklist,e,t.logger)().then((e=>{if(t.logger.debug(this.name,"using blocklist",e),this.isBlocklisted(e,this.window.location.href,t.logger))return Promise.reject("blocklisted url found. Abort ad pipeline run")}));default:return Promise.resolve()}}))]:[]}getBlocklist(e,t,i){switch(e.provider){case"static":return()=>Promise.resolve(e.blocklist);case"dynamic":let o;return()=>(o||(o=this.loadConfigWithRetry(t,e.endpoint,3).catch((e=>(i.error(this.name,"Fetching blocklisted urls failed",e),{urls:[]})))),o)}}loadConfigWithRetry(e,t,i,o=null){return i<=0?Promise.reject(o):e.loadJson("blocklist-urls.json",t).catch((o=>new Promise((e=>setTimeout(e,100/i))).then((()=>this.loadConfigWithRetry(e,t,i-1,o)))))}configureSteps(){return[]}prepareRequestAdsSteps(){return[]}}window.moli.registerModule(new BlocklistedUrls);class Cleanup{constructor(){this.name="cleanup",this.description="cleanup out-of-page formats on navigation or ad-reload",this.moduleType="creatives",this.cleanupConfig=null,this.cleanUp=(context,configs)=>{configs.forEach((config=>{"cssSelectors"in config.deleteMethod?config.deleteMethod.cssSelectors.forEach((e=>{const t=context.window.document.querySelectorAll(e);context.logger.debug("Cleanup Module",`Remove elements with selector ${e} from dom`,t),t.forEach((t=>{try{t.remove()}catch(t){context.logger.error("Cleanup Module",`Error removing element with selector ${e}`,t)}}))})):config.deleteMethod.jsAsString.forEach((jsLineAsString=>{try{context.logger.debug("Cleanup Module",`Try to execute JS line string: '${jsLineAsString}'`),eval(jsLineAsString)}catch(e){context.logger.error("Cleanup Module",`Error executing JS string: '${jsLineAsString}'`,e)}}))}))},this.hasBidderWonLastAuction=(e,t)=>{const i=e.window.pbjs.getAllWinningBids(),o=i.find((e=>e.adUnitCode===t.domId))?.bidder;return o===t.bidder}}configure(e){e?.cleanup&&e.cleanup.enabled&&(this.cleanupConfig=e.cleanup)}config(){return this.cleanupConfig}initSteps(){return[]}configureSteps(){const e=this.cleanupConfig;return e?[mkConfigureStepOncePerRequestAdsCycle("destroy-out-of-page-ad-format",(t=>(this.cleanUp(t,e.configs),Promise.resolve())))]:[]}prepareRequestAdsSteps(){const e=this.cleanupConfig;return e?[mkPrepareRequestAdsStep("cleanup-before-ad-reload",HIGH_PRIORITY,((t,i)=>{const o=e.configs.filter((e=>i.map((e=>e.moliSlot.domId)).includes(e.domId))).filter((e=>this.hasBidderWonLastAuction(t,e)));return this.cleanUp(t,o),Promise.resolve()}))]:[]}}window.moli.registerModule(new Cleanup);class Confiant{constructor(){this.name="confiant",this.description="ad fraud detection and protection module",this.moduleType="ad-fraud",this.gvlid="56",this.confiantConfig=null}config(){return this.confiantConfig}configure(e){e?.confiant&&e.confiant.enabled&&(this.confiantConfig=e.confiant)}initSteps(e){return this.confiantConfig?[mkInitStep("confiant-init",(t=>this.loadConfiant(t,e)))]:[]}loadConfiant(e,t){return"test"===e.env||e.tcData.gdprApplies&&(!e.tcData.purpose.consents[1]||this.confiantConfig?.checkGVLID&&!e.tcData.vendor.consents[this.gvlid])||t.loadScript({name:this.name,loadMethod:AssetLoadMethod.TAG,assetUrl:this.gvlid}).catch((t=>e.logger.error("failed to load confiant",t))),Promise.resolve()}configureSteps(){return[]}prepareRequestAdsSteps(){return[]}}window.moli.registerModule(new Confiant);class Pubstack{constructor(){this.name="pubstack",this.description="prebid analytics integration",this.moduleType="reporting",this.pubstackConfig=null}config(){return this.pubstackConfig}configure(e){e?.pubstack&&e.pubstack.enabled&&(this.pubstackConfig=e.pubstack)}initSteps(e){const t=this.pubstackConfig;return t?[mkInitStep("pubstack-init",(i=>("test"===i.env||e.loadScript({name:"pubstack",loadMethod:AssetLoadMethod.TAG,assetUrl:`https://boot.pbstck.com/v1/tag/${t.tagId}`}).catch((e=>i.logger.error("failed to load pubstack",e))),Promise.resolve())))]:[]}configureSteps(){return this.pubstackConfig?[mkConfigureStep("pubstack-configure",(e=>{if("test"===e.env)return Promise.resolve();const t=e.window.document.head.querySelector('meta[name="pbstck_context:pbstck_ab_test"]');return t&&t.content&&["0","1","2","3"].includes(t.content)&&e.window.googletag.pubads().setTargeting("pbstck_ab_test",t.content),Promise.resolve()}))]:[]}prepareRequestAdsSteps(){return[]}}var prebidjs,SkinConfigEffect;window.moli.registerModule(new Pubstack),function(e){e.Adagio="adagio",e.AdaptMx="amx",e.Adform="adf",e.AdUp="aduptech",e.Criteo="criteo",e.ConnectAd="connectad",e.AppNexusAst="appnexusAst",e.AppNexus="appnexus",e.GumGum="gumgum",e.ImproveDigital="improvedigital",e.IndexExchange="ix",e.Invibes="invibes",e.NanoInteractive="nanointeractive",e.PubMatic="pubmatic",e.Ogury="ogury",e.OneTag="onetag",e.OpenX="openx",e.SmartAdServer="smartadserver",e.Smartx="smartx",e.Unruly="unruly",e.Teads="teads",e.Triplelift="triplelift",e.Yieldlab="yieldlab",e.Seedtag="seedtag",e.Spotx="spotx",e.ShowHeroes="showheroesBs",e.StroeerCore="stroeerCore",e.Xaxis="xhb",e.DSPX="dspx",e.Rubicon="rubicon",e.Recognified="rads",e.Visx="visx",e.Vlyby="vlyby",e.Orbidder="orbidder"}(prebidjs||(prebidjs={})),function(e){e.BlockSkinSlot="BlockSkinSlot",e.BlockOtherSlots="BlockOtherSlots",e.NoBlocking="NoBlocking"}(SkinConfigEffect||(SkinConfigEffect={}));class Skin{constructor(){this.name="skin",this.description="Block other ad slots if a wallpaper has won the auction",this.moduleType="prebid",this.skinModuleConfig=null,this.currentSkinAdReloadSetTimeoutId=null,this.getConfigEffect=(e,t,i,o)=>{const s=t.bidsReceived?.filter((t=>t.adUnitCode===e.skinAdSlotDomId)),r=flatten((t.adUnitCodes||[]).filter((t=>e.blockedAdSlotDomIds.indexOf(t)>-1)).map((e=>({adSlotId:e,bids:t.bidsReceived?.filter((t=>t.adUnitCode===e))}))).filter((e=>isNotNull(e.bids))).map((e=>e.bids.sort(((e,t)=>t.cpm-e.cpm)).slice(0,1)))),n=r.reduce(((e,t)=>e+t.cpm),0),a=s?s.filter((t=>{const i=e.formatFilter.some((e=>{switch(e.bidder){case"*":return!0;case"appnexus":case"appnexusAst":return t.bidder===prebidjs.AppNexusAst||t.bidder===prebidjs.AppNexus;case"improvedigital":return t.bidder===prebidjs.ImproveDigital;case"gumgum":return t.bidder===prebidjs.GumGum&&(void 0===e.auid||"string"!=typeof t.ad&&t.ad.auid===e.auid);case"dspx":return t.bidder===prebidjs.DSPX;case"visx":return t.bidder===prebidjs.Visx;case"yieldlab":return t.bidder===prebidjs.Yieldlab;default:return!1}}));return t.cpm>0&&i})).sort(((e,t)=>t.cpm-e.cpm)):[],d=a.length>0?a[0].cpm>n?SkinConfigEffect.BlockOtherSlots:SkinConfigEffect.BlockSkinSlot:SkinConfigEffect.NoBlocking;return i.debug(this.name,"nonSkinBids",r),i.debug(this.name,"skinBids",a),o&&d===SkinConfigEffect.BlockSkinSlot&&(o({skin:a[0].cpm,combinedNonSkinSlots:n},e,a[0]),this.log&&this.log.debug(this.name,"trackSkinCpmLow",r)),e.enableCpmComparison?d:a.length>0?SkinConfigEffect.BlockOtherSlots:SkinConfigEffect.NoBlocking},this.selectConfig=(e,t,i)=>e.configs.map((o=>({skinConfig:o,configEffect:this.getConfigEffect(o,t,i,e.trackSkinCpmLow)}))).find((({configEffect:e})=>e!==SkinConfigEffect.NoBlocking)),this.destroyAdSlots=(e,t)=>{const i=t.googletag.pubads().getSlots().filter((t=>e.includes(t.getSlotElementId())));i.length>0&&t.googletag.destroySlots(i)},this.runSkinConfigs=(e,t,i)=>{const o=this.selectConfig(e,t,i.logger);if(o){const{skinConfig:e,configEffect:s}=o;if(s===SkinConfigEffect.BlockOtherSlots){i.logger.debug("SkinModule","Skin configuration applied",e),this.destroyAdSlots(e.blockedAdSlotDomIds,i.window),e.hideBlockedSlots&&e.blockedAdSlotDomIds.forEach(this.hideAdSlot(i.logger,i.window)),e.hideSkinAdSlot&&this.hideAdSlot(i.logger,i.window)(e.skinAdSlotDomId),e.hideBlockedSlotsSelector&&i.window.document.querySelectorAll(e.hideBlockedSlotsSelector).forEach((t=>{i.logger.debug("SkinModule",`Set display:none for container with selector ${e.hideBlockedSlotsSelector}`),t.style.setProperty("display","none")}));const o=t.bidsReceived?.filter((t=>t.adUnitCode===e.skinAdSlotDomId)).sort(((e,t)=>t.cpm-e.cpm))[0];if(e.adReload?.intervalMs&&o?.bidder&&e.adReload.allowed.includes(o.bidder)){const t=i.config.slots.filter((t=>t.domId===e.skinAdSlotDomId||e.blockedAdSlotDomIds.includes(t.domId))).map((e=>e.behaviour.loaded));t.every((e=>e===t[0]))&&"infinite"!==t[0]?(this.currentSkinAdReloadSetTimeoutId&&clearTimeout(this.currentSkinAdReloadSetTimeoutId),this.currentSkinAdReloadSetTimeoutId=i.window.setTimeout((()=>{var o;i.window.moli.refreshAdSlot([...e.blockedAdSlotDomIds,e.skinAdSlotDomId],{loaded:t[0]}),(o=e.skinAdSlotDomId,i.window.googletag.pubads().getSlots().find((e=>e.getSlotElementId()===o)))?.setTargeting("native-reload","true"),i.logger.info("SkinModule","Ad reload for skin and blocked slots triggered",e.skinAdSlotDomId,e.blockedAdSlotDomIds)}),e.adReload?.intervalMs)):i.logger.error("SkinModule","Ad reload not possible because of different loading behaviors of the slots that should be refreshed:",t)}}else e.enableCpmComparison&&(i.logger.debug("SkinModule","Skin configuration ignored because cpm was low",e),this.destroyAdSlots([e.skinAdSlotDomId],i.window))}else{const o=e.configs.filter((e=>e.destroySkinSlot)).map((e=>e.skinAdSlotDomId)).filter(uniquePrimitiveFilter).filter((e=>!1===t.adUnitCodes?.includes(e)));this.destroyAdSlots(o,i.window)}},this.hideAdSlot=(e,t)=>i=>{const o=t.document.getElementById(i);try{o&&(e.debug("SkinModule",`Set display:none for ${i}`),o.style.setProperty("display","none"))}catch(t){e.error("SkinModule",`Couldn't set the the wallpaper div ${i} to display:none;`,t)}}}config(){return this.skinModuleConfig}configure(e){e?.skin&&e.skin.enabled&&(this.skinModuleConfig=e.skin)}initSteps(){const e=this.skinModuleConfig;return e?[mkInitStep("skin-init",(t=>("test"===t.env||t.window.pbjs.que.push((()=>{t.window.pbjs.onEvent("auctionEnd",(i=>{this.runSkinConfigs(e,i,t)}))})),Promise.resolve())))]:[]}configureSteps(){return[]}prepareRequestAdsSteps(){return[]}}window.moli.registerModule(new Skin),window.moli.requestAds();const currentScript=window.document.currentScript??document.getElementById("moli-ad-tag"),pubCodeOverride=resolveOverrides(window,QueryParameters.moliPubCode,BrowserStorageKeys.moliPubCode)[0]?.value,versionOverride=resolveOverrides(window,QueryParameters.moliVersion,BrowserStorageKeys.moliVersion)[0]?.value;if(currentScript){const e=pubCodeOverride??currentScript.getAttribute("data-pub-code"),t=versionOverride??currentScript.getAttribute("data-version")??"prod",i=currentScript.getAttribute("data-endpoint")??"cdn.h5v.eu/publisher/config",o=currentScript.getAttribute("data-endpoint-fallback")??"cdn-fallback.h5v.eu/publisher/config";if(e){const s=`//${i}/${e}/${t}.json`;fetch(s).then((e=>e.json())).catch((i=>(console.error(`Failed to load configuration from ${s}. Using fallback`,i),fetch(`//${o}/${e}/${t}.json`)))).then((e=>window.moli.configure(e))).catch((e=>console.error(`Failed to load configuration from ${s}:`,e)))}else console.error('No publisher code provided for ad tag configuration! Add the `data-pub-code="yourCode"` attribute to the script tag.')}else console.error("Failed to find the current script tag for the ad tag bundle!");
